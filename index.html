<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mapa de Aldeas</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  height: 100vh;
  overflow: hidden;
  background-color: #4da6ff;
  font-family: sans-serif;
  transition: background-color 0.5s ease;
}
body.night-mode { background-color: #1a1a2e; }
.map-view, .island-view {
  position: absolute;
  width: 100%;
  height: 100%;
  transition: opacity 0.4s ease;
}
.island-view {
  opacity: 0;
  pointer-events: none;
  background-color: #4da6ff;
}
body.night-mode .island-view { background-color: #1a1a2e; }
.map-view::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 20, 0);
  pointer-events: none;
  transition: background 0.5s ease;
  z-index: 1;
}
body.night-mode .map-view::before { background: rgba(0, 0, 20, 0.6); }
.viewport {
  width: 100%;
  height: 100%;
  overflow: hidden;
  position: relative;
  cursor: grab;
}
.world {
  position: absolute;
  transform-origin: 0 0;
  width: 100%;
  height: 100%;
}
.grid {
  position: absolute;
  display: grid;
  grid-template-columns: repeat(50, 40px);
  grid-template-rows: repeat(50, 40px);
  gap: 2px;
  background-color: #4da6ff;
  padding: 200px;
  transition: background-color 0.5s ease;
}
body.night-mode .grid { background-color: #1a1a2e; }
.grid.no-grid { gap: 0px; }
.grid.island {
  grid-template-columns: repeat(20, 40px);
  grid-template-rows: repeat(20, 40px);
}
.cell {
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  color: white;
  font-weight: bold;
  border-radius: 4px;
  user-select: none;
  cursor: pointer;
  position: relative;
}
.grid.no-grid .cell { border-radius: 0px; }
.cell .owner-name {
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0, 0, 0, 0.8);
  color: white;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 12px;
  white-space: nowrap;
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.2s;
  margin-bottom: 5px;
  z-index: 100;
}
.cell:hover .owner-name { opacity: 1; }
.grass {
  background-color: #4CAF50;
  transition: background-color 0.5s ease;
}
body.night-mode .grass { background-color: #2d5016; }
.road {
  background-color: #A1887F;
  transition: background-color 0.5s ease;
}
body.night-mode .road { background-color: #5d4e42; }
.mountain {
  background-color: #9E9E9E;
  transition: background-color 0.5s ease;
}
body.night-mode .mountain { background-color: #4a4a4a; }
.building {
  background-color: #8B4513;
  cursor: pointer;
  transition: transform 0.3s ease;
}
.building:hover { transform: scale(1.2); }
.wall { background-color: #9E9E9E; }
.gold-mine {
  background-color: #FFD700;
  color: #000;
}
body.night-mode .gold-mine { background-color: #b39700; }
.rocket-launcher, .statue {
  background-color: #666;
  color: white;
}
body.night-mode .rocket-launcher, body.night-mode .statue { background-color: #444; }
.damaged {
  background-color: #8B4513;
}
body.night-mode .damaged { background-color: #5d2e0b; }
.center {
  background-color: #8B4513;
}
body.night-mode .center { background-color: #5d2e0b; }
.particula {
  position: absolute;
  width: 4px;
  height: 4px;
  background: red;
  border-radius: 50%;
  opacity: 1;
  animation: subir 1.5s linear forwards;
}
@keyframes subir {
  0% {
    transform: translateY(0) scale(1);
    opacity: 1;
  }
  100% {
    transform: translateY(-60px) scale(0.3);
    opacity: 0;
  }
}
.explosion-particle {
  position: absolute;
  width: 8px;
  height: 8px;
  border-radius: 50%;
  pointer-events: none;
  z-index: 10001;
}
@keyframes explode {
  0% {
    transform: translate(0, 0) scale(1);
    opacity: 1;
  }
  100% {
    opacity: 0;
  }
}
@keyframes shake {
  0%, 100% { transform: translate(0, 0); }
  10%, 30%, 50%, 70%, 90% { transform: translate(-10px, -10px); }
  20%, 40%, 60%, 80% { transform: translate(10px, 10px); }
}
.shake {
  animation: shake 0.5s ease-in-out;
}
.btn {
  position: fixed;
  padding: 12px 20px;
  background: white;
  border: none;
  border-radius: 8px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.3);
  cursor: pointer;
  font-size: 14px;
  font-weight: bold;
  z-index: 1000;
  transition: background 0.3s, transform 0.3s;
}
.btn:hover { background: #f0f0f0; }
.btn.primary {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  font-size: 18px;
  padding: 15px 30px;
  border-radius: 10px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.3);
}
.btn.primary:hover {
  transform: scale(1.05);
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}
.btn.danger {
  background: linear-gradient(135deg, #ff0000 0%, #8b0000 100%);
}
.btn.gold {
  background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%);
}
.btn.success {
  background: linear-gradient(135deg, #89ff00 0%, #00bcd4 100%);
}
.btn.pink {
  background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
}
#gridToggle { top: 20px; right: 20px; }
#logoutButton { top: 70px; right: 20px; }
#dayNightToggle { top: 120px; right: 20px; font-size: 24px; }
#backButton { bottom: 20px; left: 20px; font-size: 16px; }
#islandGridToggle { bottom: 70px; left: 20px; opacity: 0; pointer-events: none; }
#islandAchievementsButton { top: 170px; right: 20px; opacity: 0; pointer-events: none; }
#shopButton, #inventoryButton, #attackButton, #achievementsButton { bottom: 20px; right: 20px; display: none; }
#inventoryButton { bottom: 80px; }
#attackButton, #achievementsButton { bottom: 140px; }
#globalShopButton { bottom: 80px; right: 20px; }
#topPlayersButton { bottom: 20px; right: 20px; }
.panel {
  position: absolute;
  background: rgba(0, 0, 0, 0.7);
  padding: 15px 20px;
  border-radius: 10px;
  color: white;
  z-index: 100;
  box-shadow: 0 4px 15px rgba(0,0,0,0.5);
  display: none;
}
#resourcesPanel { top: 20px; right: 20px; font-size: 20px; font-weight: bold; }
#userInfoPanel { top: 20px; left: 20px; min-width: 250px; }
#userInfoPanel h3 { margin: 0 0 10px 0; font-size: 18px; }
#levelInfo { font-size: 16px; margin-bottom: 8px; }
#xpBarContainer {
  background: rgba(255, 255, 255, 0.2);
  height: 20px;
  border-radius: 10px;
  overflow: hidden;
  margin-top: 5px;
  position: relative;
}
#xpBar {
  background: linear-gradient(90deg, #4CAF50, #8BC34A);
  height: 100%;
  width: 0%;
  transition: width 0.5s ease;
}
#xpBarText {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 12px;
  font-weight: bold;
  color: white;
  text-shadow: 0 0 3px rgba(0,0,0,0.5);
  white-space: nowrap;
}
#islandTitle {
  position: absolute;
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  color: white;
  font-size: 2em;
  text-shadow: 0 0 20px rgba(0,0,0,0.8);
  z-index: 100;
}
.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.8);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 10000;
}
.modal-content {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  padding: 30px;
  border-radius: 20px;
  max-width: 500px;
  width: 90%;
  max-height: 80vh;
  overflow-y: auto;
  box-shadow: 0 10px 50px rgba(0,0,0,0.5);
}
.modal-content.large { max-width: 600px; }
.modal-content.small { max-width: 400px; }
.modal-content h2 {
  color: white;
  margin: 0 0 20px 0;
  text-align: center;
  font-size: 28px;
}
.shop-item, .top-player-item, .achievement-item {
  background: rgba(255, 255, 255, 0.9);
  padding: 15px 20px;
  margin: 10px 0;
  border-radius: 10px;
  display: flex;
  align-items: center;
  gap: 15px;
}
.shop-item { justify-content: space-between; padding: 20px; }
.top-player-item { cursor: pointer; transition: transform 0.2s, background 0.2s; }
.top-player-item:hover {
  transform: translateX(5px);
  background: rgba(255, 255, 255, 1);
}
.achievement-item.unlocked {
  background: rgba(76, 175, 80, 0.2);
  border: 2px solid #4CAF50;
}
.shop-item-info, .top-player-info, .achievement-info { flex: 1; }
.shop-item-name, .top-player-name, .achievement-name {
  font-size: 18px;
  font-weight: bold;
  color: #333;
}
.shop-item-desc, .top-player-stats, .achievement-desc {
  font-size: 14px;
  color: #666;
  margin-top: 3px;
}
.shop-item-cost {
  font-size: 16px;
  color: #FFD700;
  font-weight: bold;
}
.shop-item button, .attack-option {
  padding: 10px 20px;
  background: #4CAF50;
  border: none;
  border-radius: 8px;
  color: white;
  font-weight: bold;
  cursor: pointer;
  font-size: 16px;
  transition: background 0.3s;
}
.shop-item button:hover { background: #45a049; }
.shop-item button:disabled {
  background: #ccc;
  cursor: not-allowed;
}
.attack-option {
  display: block;
  width: 100%;
  margin: 10px 0;
  padding: 15px;
  background: rgba(255, 255, 255, 0.9);
  color: #333;
}
.modal-close {
  display: block;
  margin: 20px auto 0;
  padding: 12px 30px;
  background: rgba(255, 255, 255, 0.2);
  border: 2px solid white;
  border-radius: 8px;
  color: white;
  font-weight: bold;
  cursor: pointer;
  font-size: 16px;
}
.modal-close:hover { background: rgba(255, 255, 255, 0.3); }
.login-tabs {
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
}
.tab-button {
  flex: 1;
  padding: 12px;
  background: rgba(255, 255, 255, 0.2);
  border: none;
  border-radius: 8px;
  color: white;
  font-weight: bold;
  cursor: pointer;
  font-size: 16px;
  transition: background 0.3s;
}
.tab-button.active { background: rgba(255, 255, 255, 0.4); }
.tab-button:hover { background: rgba(255, 255, 255, 0.3); }
.login-form {
  display: none;
}
.login-form.active { display: block; }
.form-group {
  margin-bottom: 20px;
}
.form-group label {
  display: block;
  color: white;
  margin-bottom: 8px;
  font-weight: bold;
}
.form-group input {
  width: 100%;
  padding: 12px;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  box-sizing: border-box;
}
.form-group input:focus { outline: 2px solid white; }
.login-button {
  width: 100%;
  padding: 15px;
  background: #4CAF50;
  border: none;
  border-radius: 8px;
  color: white;
  font-weight: bold;
  cursor: pointer;
  font-size: 18px;
  transition: background 0.3s;
}
.login-button:hover { background: #45a049; }
.error-message {
  color: #ffcccc;
  background: rgba(255, 0, 0, 0.2);
  padding: 10px;
  border-radius: 5px;
  margin-top: 15px;
  text-align: center;
  display: none;
}
.tutorial-step {
  display: none;
  color: white;
}
.tutorial-step.active { display: block; }
.tutorial-icon {
  font-size: 80px;
  margin: 20px 0;
}
.tutorial-text {
  font-size: 18px;
  line-height: 1.6;
  margin: 20px 0;
}
.tutorial-buttons {
  display: flex;
  gap: 15px;
  margin-top: 30px;
  justify-content: center;
}
.tutorial-button {
  padding: 15px 30px;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  font-weight: bold;
  cursor: pointer;
  transition: transform 0.2s;
}
.tutorial-button:hover { transform: scale(1.05); }
.tutorial-button.primary {
  background: #4CAF50;
  color: white;
}
.tutorial-button.secondary {
  background: rgba(255, 255, 255, 0.2);
  color: white;
  border: 2px solid white;
}
.tutorial-progress {
  color: rgba(255, 255, 255, 0.7);
  margin-top: 20px;
  font-size: 14px;
}
.top-player-rank {
  font-size: 24px;
  font-weight: bold;
  width: 40px;
  text-align: center;
}
.top-player-rank.first { color: #FFD700; }
.top-player-rank.second { color: #C0C0C0; }
.top-player-rank.third { color: #CD7F32; }
.top-player-xp {
  font-size: 16px;
  font-weight: bold;
  color: #4CAF50;
}
.achievement-icon {
  font-size: 40px;
  min-width: 50px;
  text-align: center;
}
.achievement-reward {
  font-size: 12px;
  color: #4CAF50;
  font-weight: bold;
  margin-top: 5px;
}
.achievement-status {
  font-size: 16px;
  font-weight: bold;
  color: #4CAF50;
}
.achievement-status.locked { color: #999; }
#fade {
  position: absolute;
  width: 100%;
  height: 100%;
  background-color: black;
  opacity: 0;
  transition: opacity 0.4s ease;
  pointer-events: none;
  z-index: 9999;
}
#loading {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(0, 0, 0, 0.8);
  color: white;
  padding: 20px 40px;
  border-radius: 10px;
  font-size: 18px;
  z-index: 10000;
  display: none;
}
</style>
</head>
<body>
<div class="map-view">
  <div class="viewport" id="mainViewport">
    <div class="world" id="mainWorld">
      <div class="grid" id="mainGrid"></div>
    </div>
  </div>
  <button class="btn" id="gridToggle">Quitar Cuadrícula</button>
  <button class="btn" id="logoutButton">Cerrar Sesión</button>
  <button class="btn" id="dayNightToggle">🌙</button>
  <button class="btn gold primary" id="achievementsButton">🏆 Logros</button>
  <button class="btn success primary" id="globalShopButton">🌐 Tienda Global</button>
  <button class="btn pink primary" id="topPlayersButton">🏆 Top Jugadores</button>
</div>
<div class="island-view">
  <button class="btn" id="backButton">← Volver al Mapa</button>
  <button class="btn" id="islandGridToggle">Quitar Cuadrícula</button>
  <button class="btn gold primary" id="islandAchievementsButton">🏆 Logros</button>
  <div id="islandTitle">Aldea de <span id="ownerName"></span></div>
  <div class="panel" id="userInfoPanel">
    <h3 id="userName"></h3>
    <div id="levelInfo">Nivel: <span id="userLevel">1</span></div>
    <div id="xpBarContainer">
      <div id="xpBar"></div>
      <div id="xpBarText">0 / 100 XP</div>
    </div>
  </div>
  <div class="panel" id="resourcesPanel">
    💰<span id="goldAmount">0</span>
  </div>
  <button class="btn primary" id="shopButton">🛒 Tienda</button>
  <button class="btn primary" id="inventoryButton">🎒 Inventario</button>
  <button class="btn danger primary" id="attackButton">⚔️ Atacar</button>
  <div class="viewport" id="islandViewport">
    <div class="world" id="islandWorld">
      <div class="grid island" id="islandGrid"></div>
    </div>
  </div>
</div>
<div class="modal" id="shopModal">
  <div class="modal-content">
    <h2>🛒 Tienda</h2>
    <div class="shop-item">
      <div class="shop-item-info">
        <div class="shop-item-name">⛏️ Mina de Oro</div>
        <div class="shop-item-desc">Genera 10 de oro cada 5 segundos</div>
        <div class="shop-item-desc">Tienes: <span id="mineCount">0</span> / 2</div>
        <div class="shop-item-cost">💰 50 Oro</div>
      </div>
      <button id="buyMineBtn">Comprar</button>
    </div>
    <div class="shop-item">
      <div class="shop-item-info">
        <div class="shop-item-name">🚀 Lanza Cohetes</div>
        <div class="shop-item-desc">Estructura avanzada para ataques de cohetes</div>
        <div class="shop-item-desc">Tienes: <span id="rocketLauncherCount">0</span> / 1</div>
        <div class="shop-item-cost">💰 2000 Oro</div>
      </div>
      <button id="buyRocketLauncherBtn">Comprar</button>
    </div>
    <div class="shop-item">
      <div class="shop-item-info">
        <div class="shop-item-name">🛠️ Pala</div>
        <div class="shop-item-desc">Repara áreas dañadas en tu aldea</div>
        <div class="shop-item-cost">💰 50 Oro</div>
      </div>
      <button id="buyShovelBtn">Comprar</button>
    </div>
    <button class="modal-close" id="closeShop">Cerrar</button>
  </div>
</div>
<div class="modal" id="inventoryModal">
  <div class="modal-content">
    <h2>🎒 Inventario</h2>
    <div id="inventoryItems"></div>
    <button class="modal-close" id="closeInventory">Cerrar</button>
  </div>
</div>
<div class="modal" id="globalShopModal">
  <div class="modal-content">
    <h2>🌐 Tienda Global</h2>
    <div class="shop-item">
      <div class="shop-item-info">
        <div class="shop-item-name">🗿 Estatua Moai</div>
        <div class="shop-item-desc">Estatua decorativa única para tu aldea</div>
        <div class="shop-item-desc">Stock: <span id="statueStock">10</span></div>
        <div class="shop-item-cost">💰 500 Oro</div>
      </div>
      <button id="buyStatueBtn">Comprar</button>
    </div>
    <div class="shop-item">
      <div class="shop-item-info">
        <div class="shop-item-name">🚀 Cohetes</div>
        <div class="shop-item-desc">Municiones para el Lanza Cohetes</div>
        <div class="shop-item-desc">Stock: <span id="rocketAmmoStock">10</span></div>
        <div class="shop-item-cost">💰 3000 Oro</div>
      </div>
      <button id="buyRocketAmmoBtn">Comprar</button>
    </div>
    <button class="modal-close" id="closeGlobalShop">Cerrar</button>
  </div>
</div>
<div class="modal" id="attackModal">
  <div class="modal-content small">
    <h2>Elige Ataque</h2>
    <button class="attack-option" data-attack="rob">Robar Oro (100 oro, roba hasta 50)</button>
    <button class="attack-option" data-attack="bomb">Lanzar Bomba (100 oro, daña área 3x3)</button>
    <button class="attack-option" data-attack="rocket">Lanzar Cohete (Requiere munición, daña área 7x7)</button>
    <button class="modal-close" id="closeAttack">Cancelar</button>
  </div>
</div>
<div class="modal" id="topPlayersModal">
  <div class="modal-content">
    <h2>🏆 Top Jugadores</h2>
    <div id="topPlayersList"></div>
    <button class="modal-close" id="closeTopPlayers">Cerrar</button>
  </div>
</div>
<div class="modal" id="achievementsModal">
  <div class="modal-content large">
    <h2>🏆 Logros</h2>
    <div id="achievementsList"></div>
    <button class="modal-close" id="closeAchievements">Cerrar</button>
  </div>
</div>
<div class="modal" id="tutorialModal">
  <div class="modal-content large">
    <h2>🎓 Tutorial</h2>
    <div id="tutorialSteps">
      <div class="tutorial-step active" data-step="1">
        <div class="tutorial-icon">👋</div>
        <div class="tutorial-text">¡Bienvenido a Aldeas!<br><br>Este es un juego de construcción y estrategia donde podrás crear tu propia aldea y competir con otros jugadores.</div>
      </div>
      <div class="tutorial-step" data-step="2">
        <div class="tutorial-icon">🏰</div>
        <div class="tutorial-text">Para empezar, haz click en cualquier <strong>celda verde</strong> del mapa para construir tu aldea.<br><br>Solo puedes construir una aldea, ¡así que elige bien la ubicación!</div>
      </div>
      <div class="tutorial-step" data-step="3">
        <div class="tutorial-icon">🏝️</div>
        <div class="tutorial-text">Una vez construida, haz click en tu castillo para entrar a tu isla.<br><br>Aquí podrás construir edificios y mejorar tu aldea.</div>
      </div>
      <div class="tutorial-step" data-step="4">
        <div class="tutorial-icon">💰</div>
        <div class="tutorial-text">En la tienda puedes comprar <strong>Minas de Oro</strong> que generan oro cada 5 segundos.<br><br>El oro te permite comprar más edificios y mejorar tu aldea.</div>
      </div>
      <div class="tutorial-step" data-step="5">
        <div class="tutorial-icon">📈</div>
        <div class="tutorial-text">Gana <strong>XP</strong> construyendo edificios y generando recursos.<br><br>Sube de nivel para desbloquear más contenido y aparecer en el ranking.</div>
      </div>
      <div class="tutorial-step" data-step="6">
        <div class="tutorial-icon">🎮</div>
        <div class="tutorial-text">¡Eso es todo!<br><br>Explora el mapa, visita otras aldeas y conviértete en el mejor jugador.<br><br><strong>¡Buena suerte!</strong></div>
      </div>
    </div>
    <div class="tutorial-buttons">
      <button class="tutorial-button secondary" id="tutorialPrev">← Anterior</button>
      <button class="tutorial-button primary" id="tutorialNext">Siguiente →</button>
    </div>
    <div class="tutorial-progress">Paso <span id="tutorialCurrentStep">1</span> de <span id="tutorialTotalSteps">6</span></div>
  </div>
</div>
<div class="modal" id="loginModal">
  <div class="modal-content small">
    <h2>🏰 Aldeas</h2>
    <div class="login-tabs">
      <button class="tab-button active" id="loginTab">Iniciar Sesión</button>
      <button class="tab-button" id="registerTab">Registrarse</button>
    </div>
    <div id="loginForm" class="login-form active">
      <div class="form-group">
        <label>Nombre de Usuario</label>
        <input type="text" id="loginUsername" placeholder="Ingresa tu nombre">
      </div>
      <div class="form-group">
        <label>Contraseña</label>
        <input type="password" id="loginPassword" placeholder="Ingresa tu contraseña">
      </div>
      <button class="login-button" id="loginBtn">Entrar</button>
      <div class="error-message" id="loginError"></div>
    </div>
    <div id="registerForm" class="login-form">
      <div class="form-group">
        <label>Nombre de Usuario</label>
        <input type="text" id="registerUsername" placeholder="Elige un nombre">
      </div>
      <div class="form-group">
        <label>Contraseña</label>
        <input type="password" id="registerPassword" placeholder="Elige una contraseña">
      </div>
      <div class="form-group">
        <label>Confirmar Contraseña</label>
        <input type="password" id="registerPasswordConfirm" placeholder="Confirma tu contraseña">
      </div>
      <button class="login-button" id="registerBtn">Crear Cuenta</button>
      <div class="error-message" id="registerError"></div>
    </div>
  </div>
</div>
<div id="fade"></div>
<div id="loading">Cargando...</div>
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { getDatabase, ref, set, onValue, get, runTransaction } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
const app = initializeApp({
  apiKey: "AIzaSyClTAw_XLfH3UcCKTisTREZchz41tTxL7g",
  authDomain: "projectmap-382dd.firebaseapp.com",
  databaseURL: "https://projectmap-382dd-default-rtdb.firebaseio.com",
  projectId: "projectmap-382dd",
  storageBucket: "projectmap-382dd.firebasestorage.app",
  messagingSenderId: "1016267509437",
  appId: "1:1016267509437:web:fa243dd82b151383ccb1d4",
  measurementId: "G-4ECYZ37F17"
});
const db = getDatabase(app);
// State
const state = {
  user: null,
  hasBuilt: false,
  currentVillage: { owner: null, id: null },
  resources: { gold: 0 },
  buildings: { mines: [], rocketLaunchers: [], statues: [], damaged: [] },
  level: { level: 1, xp: 0, needed: 100 },
  inventory: [],
  placing: null,
  attacking: false,
  achievements: {},
  tutorial: { step: 1 },
  nightMode: false,
  grids: { main: true, island: true },
  view: { main: { x: 0, y: 0, scale: 1 }, island: { x: 0, y: 0, scale: 1 } },
  drag: { active: false, moved: false, startX: 0, startY: 0 },
  map: [],
  cells: {},
  intervals: { gold: null, particles: {} },
  skipCentering: false
};
const ACHIEVEMENTS = {
  firstVillage: { id: 'firstVillage', name: 'Primer Constructor', desc: 'Construye tu primera aldea', icon: '🏰', reward: '+50 XP' },
  firstMine: { id: 'firstMine', name: 'Minero Novato', desc: 'Construye tu primera mina de oro', icon: '⛏️', reward: '+25 XP' },
  level5: { id: 'level5', name: 'Ascenso', desc: 'Alcanza el nivel 5', icon: '⭐', reward: '+100 Oro' },
  level10: { id: 'level10', name: 'Veterano', desc: 'Alcanza el nivel 10', icon: '🌟', reward: '+200 Oro' },
  rich: { id: 'rich', name: 'Rico', desc: 'Acumula 500 de oro', icon: '💰', reward: '+50 XP' },
  millionaire: { id: 'millionaire', name: 'Millonario', desc: 'Acumula 1000 de oro', icon: '💎', reward: '+100 XP' },
  maxMines: { id: 'maxMines', name: 'Imperio Minero', desc: 'Construye el máximo de minas (2)', icon: '⚒️', reward: '+50 XP' },
  explorer: { id: 'explorer', name: 'Explorador', desc: 'Visita la aldea de otro jugador', icon: '🗺️', reward: '+25 XP' },
  rocketLauncher: { id: 'rocketLauncher', name: 'Pionero Espacial', desc: 'Construye el lanza cohetes', icon: '🚀', reward: '+500 XP' }
};
// DOM Elements
const $ = id => document.getElementById(id);
const modal = name => $(name + 'Modal');
// Utility Functions
const show = el => el.style.display = el.classList.contains('modal') ? 'flex' : 'block';
const hide = el => el.style.display = 'none';
const loading = show => $(show ? 'loading' : 'loading').style.display = show ? 'block' : 'none';
// Initialize Map
function initMap() {
  const grid = $('mainGrid');
  for (let r = 0; r < 50; r++) {
    state.map[r] = [];
    for (let c = 0; c < 50; c++) {
      let terrain = r === 0 || r === 49 || c === 0 || c === 49 ? 'wall' :
                    r % 10 === 0 || c % 10 === 0 ? 'road' :
                    Math.random() < 0.05 ? 'mountain' : 'grass';
     
      state.map[r][c] = { terrain, building: null, owner: null };
     
      const cell = document.createElement('div');
      cell.className = `cell ${terrain}`;
      cell.dataset.row = r;
      cell.dataset.col = c;
      cell.onclick = () => handleMainClick(cell);
     
      state.cells[`${r}-${c}`] = cell;
      grid.appendChild(cell);
    }
  }
}
// Firebase Listeners
function setupListeners() {
  onValue(ref(db, 'villages'), snap => {
    if (!snap.exists()) return;
    Object.entries(snap.val()).forEach(([key, v]) => {
      const cell = state.cells[`${v.row}-${v.col}`];
      if (!cell) return;
     
      state.map[v.row][v.col] = { ...state.map[v.row][v.col], building: 'house', owner: v.owner };
      cell.classList.add('building');
      cell.textContent = '🏰';
     
      const label = document.createElement('div');
      label.className = 'owner-name';
      label.textContent = v.owner;
      cell.appendChild(label);
     
      if (v.underAttack) startParticles(key, cell);
      else stopParticles(key);
    });
    loading(false);
  });
}
function startParticles(id, cell) {
  if (state.intervals.particles[id]) return;
  state.intervals.particles[id] = setInterval(() => {
    const p = document.createElement('div');
    p.className = 'particula';
    p.style.left = Math.random() * cell.offsetWidth + 'px';
    p.style.top = Math.random() * cell.offsetHeight + 'px';
    p.style.background = `rgb(${150 + Math.random()*100}, 0, 0)`;
    cell.appendChild(p);
    p.onanimationend = () => p.remove();
  }, 100);
}
function stopParticles(id) {
  if (state.intervals.particles[id]) {
    clearInterval(state.intervals.particles[id]);
    delete state.intervals.particles[id];
  }
}
// Main Map Interactions
async function handleMainClick(cell) {
  if (state.drag.moved) return;
  const r = +cell.dataset.row, c = +cell.dataset.col;
 
  if (state.map[r][c].building === 'house') {
    openIsland(state.map[r][c].owner);
    return;
  }
 
  if (state.hasBuilt || state.map[r][c].terrain !== 'grass' || state.map[r][c].building) {
    if (state.hasBuilt) alert('Ya has colocado tu aldea. Solo puedes construir una aldea.');
    return;
  }
 
  loading(true);
  const id = `${r}-${c}`;
  await set(ref(db, `villages/${id}`), { row: r, col: c, owner: state.user, timestamp: Date.now() });
  state.hasBuilt = true;
  await unlockAchievement('firstVillage');
  loading(false);
}
// Island Functions
async function openIsland(owner) {
  state.currentVillage = { owner, id: null };
  $('ownerName').textContent = owner;
 
  if (owner !== state.user && state.user) unlockAchievement('explorer');
 
  await Promise.all([loadBuildings(owner), loadResources(owner), loadLevel(owner)]);
 
  if (owner === state.user && state.buildings.mines.length > 0) startGoldGen();
 
  renderIsland();
  if (!state.skipCentering) {
    setTimeout(() => {
      const viewport = $('islandViewport');
      const grid = $('islandGrid');
      state.view.island.x = (viewport.clientWidth - grid.offsetWidth * state.view.island.scale) / 2;
      state.view.island.y = (viewport.clientHeight - grid.offsetHeight * state.view.island.scale) / 2;
      updateTransform('island');
    }, 50);
  }
  transition(true);
 
  $('shopButton').style.display = owner === state.user ? 'block' : 'none';
  $('inventoryButton').style.display = owner === state.user ? 'block' : 'none';
  $('attackButton').style.display = owner !== state.user && state.user ? 'block' : 'none';
}
function renderIsland() {
  const grid = $('islandGrid');
  grid.innerHTML = '';
 
  for (let r = 0; r < 20; r++) {
    for (let c = 0; c < 20; c++) {
      const cell = document.createElement('div');
      cell.className = 'cell grass';
      cell.dataset.row = r;
      cell.dataset.col = c;
      cell.onclick = () => handleIslandClick(cell);
     
      if (r === 10 && c === 10) {
        cell.classList.add('center');
        cell.classList.remove('grass');
        cell.textContent = '🏰';
      }
     
      grid.appendChild(cell);
    }
  }
 
  setTimeout(() => {
    state.buildings.mines.forEach(m => {
      const c = grid.querySelector(`[data-row="${m.row}"][data-col="${m.col}"]`);
      if (c) { c.classList.add('gold-mine'); c.textContent = '⛏️'; }
    });
    state.buildings.rocketLaunchers.forEach(r => {
      const c = grid.querySelector(`[data-row="${r.row}"][data-col="${r.col}"]`);
      if (c) { c.classList.add('rocket-launcher'); c.textContent = '🚀'; }
    });
    state.buildings.statues.forEach(s => {
      const c = grid.querySelector(`[data-row="${s.row}"][data-col="${s.col}"]`);
      if (c) { c.classList.add('statue'); c.textContent = '🗿'; }
    });
    state.buildings.damaged.forEach(d => {
      const c = grid.querySelector(`[data-row="${d.row}"][data-col="${d.col}"]`);
      if (c) c.classList.add('damaged');
    });
  }, 100);
}
async function handleIslandClick(cell) {
  if (state.drag.moved) return;
  const r = +cell.dataset.row, c = +cell.dataset.col;
 
  if (r === 10 && c === 10) return alert('No puedes interactuar con el castillo');
  if (cell.classList.contains('gold-mine') || cell.classList.contains('rocket-launcher') || cell.classList.contains('statue')) {
    return alert('Ya hay una estructura aquí');
  }
 
  const own = state.currentVillage.owner === state.user;
 
  if (own && state.placing === 'mine') await buildMine(r, c, cell);
  else if (own && state.placing === 'rocketLauncher') await buildRocketLauncher(r, c, cell);
  else if (own && state.placing === 'statue') await placeStatue(r, c, cell);
  else if (own && state.placing === 'shovel' && cell.classList.contains('damaged')) await repair(r, c, cell);
  else if (!own && state.placing === 'bomb') await launchBomb(r, c);
  else if (!own && state.placing === 'rocket_attack') await launchRocketAttack(r, c);
}
// Building Functions
async function buildMine(r, c, cell) {
  loading(true);
  state.buildings.mines.push({row: r, col: c});
  await set(ref(db, `users/${state.user}/buildings`), {
    goldMines: state.buildings.mines,
    rocketLaunchers: state.buildings.rocketLaunchers,
    statues: state.buildings.statues,
    damaged: state.buildings.damaged
  });
  cell.classList.add('gold-mine');
  cell.textContent = '⛏️';
  await addXP(25);
  state.placing = null;
  updateShop();
  startGoldGen();
  if (state.buildings.mines.length === 1) await unlockAchievement('firstMine');
  alert('¡Mina construida! +25 XP');
  loading(false);
}
async function buildRocketLauncher(r, c, cell) {
  loading(true);
  state.buildings.rocketLaunchers.push({row: r, col: c});
  await set(ref(db, `users/${state.user}/buildings`), {
    goldMines: state.buildings.mines,
    rocketLaunchers: state.buildings.rocketLaunchers,
    statues: state.buildings.statues,
    damaged: state.buildings.damaged
  });
  cell.classList.add('rocket-launcher');
  cell.textContent = '🚀';
  await addXP(100);
  state.placing = null;
  updateShop();
  if (state.buildings.rocketLaunchers.length === 1) await unlockAchievement('rocketLauncher');
  alert('¡Lanza Cohetes construido! +100 XP');
  loading(false);
}
async function placeStatue(r, c, cell) {
  loading(true);
  state.buildings.statues.push({row: r, col: c});
  await set(ref(db, `users/${state.user}/buildings`), {
    goldMines: state.buildings.mines,
    rocketLaunchers: state.buildings.rocketLaunchers,
    statues: state.buildings.statues,
    damaged: state.buildings.damaged
  });
  cell.classList.add('statue');
  cell.textContent = '🗿';
  await addXP(50);
 
  const items = (await get(ref(db, `users/${state.user}/inventory/items`))).val() || [];
  items.splice(items.indexOf('statue'), 1);
  await set(ref(db, `users/${state.user}/inventory/items`), items);
 
  state.placing = null;
  alert('¡Estatua Moai colocada! +50 XP');
  loading(false);
}
async function repair(r, c, cell) {
  loading(true);
  state.buildings.damaged = state.buildings.damaged.filter(d => !(d.row === r && d.col === c));
  await set(ref(db, `users/${state.currentVillage.owner}/buildings`), {
    goldMines: state.buildings.mines,
    rocketLaunchers: state.buildings.rocketLaunchers,
    statues: state.buildings.statues,
    damaged: state.buildings.damaged
  });
  cell.classList.remove('damaged');
  await addXP(10);
 
  const items = (await get(ref(db, `users/${state.user}/inventory/items`))).val() || [];
  items.splice(items.indexOf('shovel'), 1);
  await set(ref(db, `users/${state.user}/inventory/items`), items);
 
  state.placing = null;
  alert('¡Área reparada! +10 XP');
  loading(false);
}
// Attack Functions
async function launchBomb(r, c) {
  loading(true);
  for (let dx = -1; dx <= 1; dx++) {
    for (let dy = -1; dy <= 1; dy++) {
      const nr = r + dx, nc = c + dy;
      if (nr >= 0 && nr < 20 && nc >= 0 && nc < 20 && !(nr === 10 && nc === 10)) {
        const target = $('islandGrid').querySelector(`[data-row="${nr}"][data-col="${nc}"]`);
        if (target && !target.classList.contains('gold-mine') && !target.classList.contains('rocket-launcher') &&
            !target.classList.contains('statue') && !target.classList.contains('damaged')) {
          state.buildings.damaged.push({row: nr, col: nc});
          target.classList.add('damaged');
        }
      }
    }
  }
  await set(ref(db, `users/${state.currentVillage.owner}/buildings`), {
    goldMines: state.buildings.mines,
    rocketLaunchers: state.buildings.rocketLaunchers,
    statues: state.buildings.statues,
    damaged: state.buildings.damaged
  });
  await addXP(30);
  state.attacking = false;
  state.placing = null;
  await set(ref(db, `villages/${state.currentVillage.id}/underAttack`), false);
  alert('¡Bomba lanzada! Área dañada. +30 XP');
  loading(false);
}
async function launchRocketAttack(r, c) {
  // Verificar si el usuario tiene munición de cohetes
  const rocketAmmoSnap = await get(ref(db, `users/${state.user}/inventory/rocketAmmo`));
  const rocketAmmo = rocketAmmoSnap.exists() ? rocketAmmoSnap.val() : 0;
  
  if (rocketAmmo <= 0) {
    alert('¡Necesitas munición de cohetes para realizar este ataque! Compra cohetes en la tienda global.');
    state.attacking = false;
    state.placing = null;
    await set(ref(db, `villages/${state.currentVillage.id}/underAttack`), false);
    loading(false);
    return;
  }
  
  // Restar una munición
  await set(ref(db, `users/${state.user}/inventory/rocketAmmo`), rocketAmmo - 1);

  // Guardar datos del ataque y zoom actual
  const attackTarget = {row: r, col: c, owner: state.currentVillage.owner, id: state.currentVillage.id};
  const targetBuildings = JSON.parse(JSON.stringify(state.buildings));
  const savedZoom = {
    x: state.view.island.x,
    y: state.view.island.y,
    scale: state.view.island.scale
  };
 
  // Obtener datos de mi aldea para el lanza cohetes
  const myBuildingsSnap = await get(ref(db, `users/${state.user}/buildings`));
  const myBuildings = myBuildingsSnap.exists() ? myBuildingsSnap.val() : {};
  const myRocketLaunchers = myBuildings.rocketLaunchers || [];
 
  if (myRocketLaunchers.length === 0) {
    alert('¡Necesitas construir un lanza cohetes en tu aldea primero!');
    state.attacking = false;
    state.placing = null;
    await set(ref(db, `villages/${attackTarget.id}/underAttack`), false);
    loading(false);
    return;
  }
 
  const myRocketLauncher = myRocketLaunchers[0];
 
  // Paso 1: Transición a mi aldea
  $('fade').style.opacity = 1;
  await new Promise(resolve => setTimeout(resolve, 400));
 
  state.skipCentering = true;
  await openIsland(state.user);
 
  // Centrar en el lanza cohetes sin animación
  const rocketLauncherCell = $('islandGrid').querySelector(`[data-row="${myRocketLauncher.row}"][data-col="${myRocketLauncher.col}"]`);
  if (!rocketLauncherCell) {
    alert('Error: No se pudo encontrar el lanza cohetes');
    loading(false);
    return;
  }
 
  const gridPadding = 200;
  const cellSize = 40;
  const gap = 2;
  const rocketWorldX = gridPadding + myRocketLauncher.col * (cellSize + gap) + cellSize / 2;
  const rocketWorldY = gridPadding + myRocketLauncher.row * (cellSize + gap) + cellSize / 2;
 
  const viewportRect = $('islandViewport').getBoundingClientRect();
  const centerX = viewportRect.width / 2;
  const centerY = viewportRect.height / 2;
 
  const currentScale = state.view.island.scale;
  state.view.island.x = centerX - rocketWorldX * currentScale;
  state.view.island.y = centerY - rocketWorldY * currentScale;
  $('islandWorld').style.transition = '';
  updateTransform('island');
 
  setTimeout(() => $('fade').style.opacity = 0, 100);
 
  // Paso 3: Lanzar cohete hacia arriba
  await new Promise(resolve => setTimeout(resolve, 500));
 
  // Obtener la posición actualizada del lanza cohetes
  const updatedRocketLauncherCell = $('islandGrid').querySelector(`[data-row="${myRocketLauncher.row}"][data-col="${myRocketLauncher.col}"]`);
  const updatedRect = updatedRocketLauncherCell.getBoundingClientRect();
 
  const rocket = document.createElement('div');
  rocket.style.position = 'fixed';
  rocket.style.fontSize = '40px';
  rocket.style.left = updatedRect.left + updatedRect.width / 2 - 20 + 'px';
  rocket.style.top = updatedRect.top + updatedRect.height / 2 - 20 + 'px';
  rocket.style.zIndex = '10001';
  rocket.textContent = '🚀';
  rocket.style.transition = 'transform 2s ease-in, opacity 0.5s ease-in';
  rocket.style.filter = 'drop-shadow(0 0 10px rgba(255, 100, 0, 0.8))';
  document.body.appendChild(rocket);
 
  // Crear estela de humo
  const smokeInterval = setInterval(() => {
    const smoke = document.createElement('div');
    smoke.style.position = 'fixed';
    smoke.style.left = rocket.style.left;
    smoke.style.top = rocket.style.top;
    smoke.style.fontSize = '24px';
    smoke.style.zIndex = '10000';
    smoke.textContent = '💨';
    smoke.style.transition = 'opacity 1s ease-out, transform 1s ease-out';
    smoke.style.opacity = '1';
    document.body.appendChild(smoke);
   
    setTimeout(() => {
      smoke.style.opacity = '0';
      smoke.style.transform = 'scale(1.5)';
    }, 100);
   
    setTimeout(() => smoke.remove(), 1100);
  }, 150);
 
  // Animar cohete hacia arriba
  setTimeout(() => {
    rocket.style.transform = 'translateY(-1000px) rotate(0deg)';
    rocket.style.opacity = '0';
  }, 100);
 
  await new Promise(resolve => setTimeout(resolve, 2000));
  clearInterval(smokeInterval);
  rocket.remove();
 
  // Paso 4: Transición a la aldea atacada
  $('fade').style.opacity = 1;
  await new Promise(resolve => setTimeout(resolve, 400));
 
  // Restaurar estado de construcción
  state.buildings = targetBuildings;
  state.skipCentering = true;
  await openIsland(attackTarget.owner);
  state.currentVillage.id = attackTarget.id;
 
  // Restaurar el zoom que tenía el usuario
  $('islandWorld').style.transition = '';
  state.view.island.x = savedZoom.x;
  state.view.island.y = savedZoom.y;
  state.view.island.scale = savedZoom.scale;
  updateTransform('island');
 
  setTimeout(() => $('fade').style.opacity = 0, 100);
 
  // Paso 5: Cohete cae desde arriba en la posición exacta del ataque
  await new Promise(resolve => setTimeout(resolve, 800));
 
  // Calcular la posición exacta de la celda objetivo en pantalla
  const targetCell = $('islandGrid').querySelector(`[data-row="${attackTarget.row}"][data-col="${attackTarget.col}"]`);
  if (!targetCell) {
    alert('Error: No se pudo encontrar la celda objetivo');
    loading(false);
    return;
  }
 
  const targetRect = targetCell.getBoundingClientRect();
  const targetCenterX = targetRect.left + targetRect.width / 2;
  const targetCenterY = targetRect.top + targetRect.height / 2;
 
  const fallingRocket = document.createElement('div');
  fallingRocket.style.position = 'fixed';
  fallingRocket.style.fontSize = '40px';
  fallingRocket.style.left = targetCenterX - 20 + 'px';
  fallingRocket.style.top = '-100px';
  fallingRocket.style.zIndex = '10001';
  fallingRocket.textContent = '🚀';
  fallingRocket.style.transform = 'rotate(180deg)';
  fallingRocket.style.transition = 'top 1.5s ease-in';
  fallingRocket.style.filter = 'drop-shadow(0 0 15px rgba(255, 50, 0, 1))';
  document.body.appendChild(fallingRocket);
 
  setTimeout(() => {
    fallingRocket.style.top = targetCenterY - 20 + 'px';
  }, 100);
 
  // Paso 6: EXPLOSIÓN con efectos
  await new Promise(resolve => setTimeout(resolve, 1500));
 
  fallingRocket.remove();
 
  // Obtener posición final para la explosión
  const finalTargetCell = $('islandGrid').querySelector(`[data-row="${attackTarget.row}"][data-col="${attackTarget.col}"]`);
  const finalTargetRect = finalTargetCell.getBoundingClientRect();
  const explosionX = finalTargetRect.left + finalTargetRect.width / 2;
  const explosionY = finalTargetRect.top + finalTargetRect.height / 2;
 
  // Efecto de temblor
  const viewport = $('islandViewport');
  viewport.classList.add('shake');
  setTimeout(() => viewport.classList.remove('shake'), 500);
 
  // Crear partículas de explosión
  createExplosion(explosionX, explosionY);
 
  // Aplicar daño (7x7)
  loading(true);
  for (let dx = -3; dx <= 3; dx++) {
    for (let dy = -3; dy <= 3; dy++) {
      const nr = attackTarget.row + dx, nc = attackTarget.col + dy;
      if (nr >= 0 && nr < 20 && nc >= 0 && nc < 20 && !(nr === 10 && nc === 10)) {
        const target = $('islandGrid').querySelector(`[data-row="${nr}"][data-col="${nc}"]`);
        if (target && !target.classList.contains('gold-mine') && !target.classList.contains('rocket-launcher') &&
            !target.classList.contains('statue') && !target.classList.contains('damaged')) {
          state.buildings.damaged.push({row: nr, col: nc});
          target.classList.add('damaged');
        }
      }
    }
  }
 
  await set(ref(db, `users/${attackTarget.owner}/buildings`), {
    goldMines: state.buildings.mines,
    rocketLaunchers: state.buildings.rocketLaunchers,
    statues: state.buildings.statues,
    damaged: state.buildings.damaged
  });
 
  await addXP(50);
  state.attacking = false;
  state.placing = null;
  await set(ref(db, `villages/${attackTarget.id}/underAttack`), false);
 
  setTimeout(() => {
    alert('¡Cohete lanzado! Área devastada (7x7). +50 XP');
    loading(false);
  }, 1000);
}
function createExplosion(x, y) {
  const colors = ['#ff4500', '#ff6347', '#ff8c00', '#ffa500', '#ffff00', '#ff0000'];
  const particleCount = 50;
 
  for (let i = 0; i < particleCount; i++) {
    const particle = document.createElement('div');
    particle.className = 'explosion-particle';
    particle.style.left = x + 'px';
    particle.style.top = y + 'px';
    particle.style.background = colors[Math.floor(Math.random() * colors.length)];
   
    const angle = (Math.PI * 2 * i) / particleCount;
    const velocity = 100 + Math.random() * 150;
    const tx = Math.cos(angle) * velocity;
    const ty = Math.sin(angle) * velocity;
   
    particle.style.animation = `explode 1s ease-out forwards`;
    particle.style.transform = `translate(${tx}px, ${ty}px) scale(${Math.random() * 2 + 0.5})`;
   
    document.body.appendChild(particle);
   
    setTimeout(() => particle.remove(), 1000);
  }
 
  // Flash de explosión
  const flash = document.createElement('div');
  flash.style.position = 'fixed';
  flash.style.left = x - 100 + 'px';
  flash.style.top = y - 100 + 'px';
  flash.style.width = '200px';
  flash.style.height = '200px';
  flash.style.borderRadius = '50%';
  flash.style.background = 'radial-gradient(circle, rgba(255,255,255,0.9) 0%, rgba(255,100,0,0.7) 30%, rgba(255,0,0,0) 70%)';
  flash.style.zIndex = '10002';
  flash.style.pointerEvents = 'none';
  flash.style.animation = 'explode 0.5s ease-out forwards';
  document.body.appendChild(flash);
  setTimeout(() => flash.remove(), 500);
}
// Resource Management
async function loadResources(owner) {
  const snap = await get(ref(db, `users/${owner}/resources`));
  let res = snap.exists() ? snap.val() : {gold: 100, lastUpdate: Date.now()};
  state.resources.gold = res.gold || 100;
 
  if (owner === state.user) {
    const buildSnap = await get(ref(db, `users/${owner}/buildings`));
    const buildings = buildSnap.exists() ? buildSnap.val() : {};
    const mineCount = (buildings.goldMines || buildings.mines || []).length;
   
    const delta = Date.now() - (res.lastUpdate || Date.now());
    const ticks = Math.floor(delta / 5000);
    if (mineCount > 0 && ticks > 0) {
      state.resources.gold += ticks * 10 * mineCount;
      await addXP(ticks);
      await checkAchievements();
    }
    await set(ref(db, `users/${owner}/resources`), {gold: state.resources.gold, lastUpdate: Date.now()});
  }
 
  updateUI();
}
async function loadLevel(owner) {
  const snap = await get(ref(db, `users/${owner}/level`));
  if (snap.exists()) {
    const d = snap.val();
    state.level = {level: d.level || 1, xp: d.xp || 0, needed: (d.level || 1) * 100};
  } else {
    state.level = {level: 1, xp: 0, needed: 100};
    if (owner === state.user) await set(ref(db, `users/${owner}/level`), state.level);
  }
  updateUI();
}
async function loadBuildings(owner) {
  const snap = await get(ref(db, `users/${owner}/buildings`));
  const b = snap.exists() ? snap.val() : {};
  state.buildings = {
    mines: b.goldMines || b.mines || [],
    rocketLaunchers: b.rocketLaunchers || [],
    statues: b.statues || [],
    damaged: b.damaged || []
  };
  updateShop();
}
async function addXP(amount) {
  let {level, xp, needed} = state.level;
  xp += amount;
 
  while (xp >= needed && level < 20) {
    xp -= needed;
    level++;
    needed = level * 100;
    alert(`¡Felicidades! ${state.user} subió al nivel ${level}`);
  }
 
  if (level >= 20) xp = Math.min(xp, needed - 1);
 
  state.level = {level, xp, needed};
  await set(ref(db, `users/${state.user}/level`), state.level);
  updateUI();
  await checkAchievements();
}
function startGoldGen() {
  if (state.intervals.gold) return;
  const firstDelay = 5000 - (Date.now() % 5000);
 
  setTimeout(async () => {
    if (state.currentVillage.owner === state.user && state.buildings.mines.length > 0) {
      state.resources.gold += 10 * state.buildings.mines.length;
      await addXP(1);
      updateUI();
      await set(ref(db, `users/${state.user}/resources`), {gold: state.resources.gold, lastUpdate: Date.now()});
    }
   
    state.intervals.gold = setInterval(async () => {
      if (state.currentVillage.owner === state.user && state.buildings.mines.length > 0) {
        state.resources.gold += 10 * state.buildings.mines.length;
        await addXP(1);
        updateUI();
        await set(ref(db, `users/${state.user}/resources`), {gold: state.resources.gold, lastUpdate: Date.now()});
      }
    }, 5000);
  }, firstDelay);
}
// UI Updates
function updateUI() {
  $('goldAmount').textContent = state.resources.gold;
  $('userName').textContent = state.currentVillage.owner;
  $('userLevel').textContent = state.level.level;
  const pct = (state.level.xp / state.level.needed) * 100;
  $('xpBar').style.width = pct + '%';
  $('xpBarText').textContent = `${state.level.xp} / ${state.level.needed} XP`;
}
function updateShop() {
  $('mineCount').textContent = state.buildings.mines.length;
  $('rocketLauncherCount').textContent = state.buildings.rocketLaunchers.length;
  $('buyMineBtn').disabled = state.buildings.mines.length >= 2;
  $('buyMineBtn').textContent = state.buildings.mines.length >= 2 ? 'Máximo alcanzado' : 'Comprar';
  $('buyRocketLauncherBtn').disabled = state.buildings.rocketLaunchers.length >= 1;
  $('buyRocketLauncherBtn').textContent = state.buildings.rocketLaunchers.length >= 1 ? 'Máximo alcanzado' : 'Comprar';
}
// Shop Functions
$('buyMineBtn').onclick = async () => {
  if (state.buildings.mines.length >= 2) return alert('Ya tienes el máximo de minas (2)');
  if (state.resources.gold < 50) return alert(`Necesitas 50 de oro. Tienes ${state.resources.gold}.`);
  state.resources.gold -= 50;
  await set(ref(db, `users/${state.user}/resources`), {gold: state.resources.gold, lastUpdate: Date.now()});
  updateUI();
  state.placing = 'mine';
  hide(modal('shop'));
  alert('Haz click en una celda verde para colocar la mina');
};
$('buyRocketLauncherBtn').onclick = async () => {
  if (state.buildings.rocketLaunchers.length >= 1) return alert('Ya tienes el máximo de lanza cohetes (1)');
  if (state.resources.gold < 2000) return alert(`Necesitas 2000 de oro. Tienes ${state.resources.gold}.`);
  state.resources.gold -= 2000;
  await set(ref(db, `users/${state.user}/resources`), {gold: state.resources.gold, lastUpdate: Date.now()});
  updateUI();
  state.placing = 'rocketLauncher';
  hide(modal('shop'));
  alert('Haz click en una celda verde para colocar el lanza cohetes');
};
$('buyShovelBtn').onclick = async () => {
  if (state.resources.gold < 50) return alert(`Necesitas 50 de oro. Tienes ${state.resources.gold}.`);
  state.resources.gold -= 50;
  await set(ref(db, `users/${state.user}/resources`), {gold: state.resources.gold, lastUpdate: Date.now()});
  updateUI();
  const items = (await get(ref(db, `users/${state.user}/inventory/items`))).val() || [];
  items.push('shovel');
  await set(ref(db, `users/${state.user}/inventory/items`), items);
  hide(modal('shop'));
  alert('¡Pala comprada! Añadida a tu inventario.');
};
$('buyStatueBtn').onclick = async () => {
  loading(true);
  try {
    const gold = state.resources.gold;
    if (gold < 500) {
      alert(`Necesitas 500 de oro. Tienes ${gold}.`);
      loading(false);
      return;
    }
   
    const result = await runTransaction(ref(db, 'globalShop/statue'), (data) => {
      // Si no hay data, inicializar con stock
      if (data === null) {
        return {stock: 10};
      }
      
      // Si no hay stock, abortar
      if (data.stock <= 0) {
        return; // abort transaction
      }
      
      // Restar 1 al stock
      return {stock: data.stock - 1};
    });
   
    if (!result.committed || (result.snapshot.val() && result.snapshot.val().stock < 0)) {
      alert('Lo sentimos, el artículo está agotado.');
      loading(false);
      // Recargar stock actual
      const stockSnap = await get(ref(db, 'globalShop/statue'));
      const currentStock = stockSnap.val()?.stock || 0;
      $('statueStock').textContent = currentStock;
      $('buyStatueBtn').disabled = currentStock <= 0;
      return;
    }
   
    // Restar oro
    state.resources.gold -= 500;
    await set(ref(db, `users/${state.user}/resources`), {gold: state.resources.gold, lastUpdate: Date.now()});
    updateUI();
   
    // Añadir al inventario
    const items = (await get(ref(db, `users/${state.user}/inventory/items`))).val() || [];
    items.push('statue');
    await set(ref(db, `users/${state.user}/inventory/items`), items);
   
    // Actualizar UI
    const newStock = result.snapshot.val().stock;
    $('statueStock').textContent = newStock;
    $('buyStatueBtn').disabled = newStock <= 0;
   
    hide(modal('globalShop'));
    alert('¡Compra exitosa! La estatua Moai ha sido añadida a tu inventario.');
  } catch(e) {
    alert('Error al comprar: ' + e.message);
    console.error(e);
  }
  loading(false);
};

$('buyRocketAmmoBtn').onclick = async () => {
  loading(true);
  try {
    const gold = state.resources.gold;
    if (gold < 3000) {
      alert(`Necesitas 3000 de oro. Tienes ${gold}.`);
      loading(false);
      return;
    }
   
    const result = await runTransaction(ref(db, 'globalShop/rocketAmmo'), (data) => {
      // Si no hay data, inicializar con stock
      if (data === null) {
        return {stock: 10};
      }
      
      // Si no hay stock, abortar
      if (data.stock <= 0) {
        return; // abort transaction
      }
      
      // Restar 1 al stock
      return {stock: data.stock - 1};
    });
   
    if (!result.committed || (result.snapshot.val() && result.snapshot.val().stock < 0)) {
      alert('Lo sentimos, los cohetes están agotados.');
      loading(false);
      // Recargar stock actual
      const stockSnap = await get(ref(db, 'globalShop/rocketAmmo'));
      const currentStock = stockSnap.val()?.stock || 0;
      $('rocketAmmoStock').textContent = currentStock;
      $('buyRocketAmmoBtn').disabled = currentStock <= 0;
      return;
    }
   
    // Restar oro
    state.resources.gold -= 3000;
    await set(ref(db, `users/${state.user}/resources`), {gold: state.resources.gold, lastUpdate: Date.now()});
    updateUI();
   
    // Añadir munición
    const currentAmmo = (await get(ref(db, `users/${state.user}/inventory/rocketAmmo`))).val() || 0;
    await set(ref(db, `users/${state.user}/inventory/rocketAmmo`), currentAmmo + 1);
   
    // Actualizar UI
    const newStock = result.snapshot.val().stock;
    $('rocketAmmoStock').textContent = newStock;
    $('buyRocketAmmoBtn').disabled = newStock <= 0;
   
    hide(modal('globalShop'));
    alert('¡Compra exitosa! Has comprado 1 cohete.');
  } catch(e) {
    alert('Error al comprar: ' + e.message);
    console.error(e);
  }
  loading(false);
};
// Attack Modal
$('closeAttack').onclick = async () => {
  hide(modal('attack'));
  if (state.currentVillage.id) await set(ref(db, `villages/${state.currentVillage.id}/underAttack`), false);
};
document.querySelectorAll('.attack-option').forEach(btn => {
  btn.onclick = async () => {
    const type = btn.dataset.attack;
    hide(modal('attack'));
    loading(true);
   
    if (type === 'rocket') {
      // Verificar si el usuario tiene munición de cohetes
      const rocketAmmoSnap = await get(ref(db, `users/${state.user}/inventory/rocketAmmo`));
      const rocketAmmo = rocketAmmoSnap.exists() ? rocketAmmoSnap.val() : 0;
      
      if (rocketAmmo <= 0) {
        alert('¡Necesitas munición de cohetes para realizar este ataque! Compra cohetes en la tienda global.');
        await set(ref(db, `villages/${state.currentVillage.id}/underAttack`), false);
        loading(false);
        return;
      }
      
      state.attacking = true;
      state.placing = 'rocket_attack';
      loading(false);
      alert('Haz click en una celda para lanzar el cohete (7x7)');
      return;
    }
    
    const cost = 100;
    const snap = await get(ref(db, `users/${state.user}/resources`));
    let gold = snap.exists() ? snap.val().gold : 0;
   
    if (gold < cost) {
      alert(`No tienes suficiente oro (necesitas ${cost}).`);
      await set(ref(db, `villages/${state.currentVillage.id}/underAttack`), false);
      loading(false);
      return;
    }
   
    gold -= cost;
    await set(ref(db, `users/${state.user}/resources`), {gold, lastUpdate: Date.now()});
   
    if (type === 'rob') {
      const vSnap = await get(ref(db, `users/${state.currentVillage.owner}/resources`));
      let vGold = vSnap.exists() ? vSnap.val().gold : 0;
      const steal = Math.min(50, Math.floor(vGold * 0.1));
     
      if (steal <= 0) {
        alert('No hay suficiente oro para robar.');
        await set(ref(db, `villages/${state.currentVillage.id}/underAttack`), false);
        loading(false);
        return;
      }
     
      gold += steal;
      vGold -= steal;
     
      await set(ref(db, `users/${state.user}/resources`), {gold, lastUpdate: Date.now()});
      await set(ref(db, `users/${state.currentVillage.owner}/resources`), {gold: vGold, lastUpdate: Date.now()});
      await addXP(20);
     
      state.resources.gold = vGold;
      updateUI();
     
      alert(`¡Ataque exitoso! Robaste ${steal} oro. +20 XP`);
      await set(ref(db, `villages/${state.currentVillage.id}/underAttack`), false);
      loading(false);
    } else {
      state.attacking = true;
      state.placing = 'bomb';
      loading(false);
      alert('Haz click en una celda para lanzar la bomba (3x3)');
    }
  };
});
// Achievements
async function unlockAchievement(id) {
  if (!state.user || state.achievements[id]) return;
  state.achievements[id] = true;
  await set(ref(db, `users/${state.user}/achievements/${id}`), true);
 
  const a = ACHIEVEMENTS[id];
  if (a) {
    alert(`🏆 ¡Logro Desbloqueado!\n${a.name}\n${a.desc}\nRecompensa: ${a.reward}`);
   
    if (a.reward.includes('XP')) {
      await addXP(parseInt(a.reward.match(/\d+/)[0]));
    } else if (a.reward.includes('Oro')) {
      const amt = parseInt(a.reward.match(/\d+/)[0]);
      state.resources.gold += amt;
      await set(ref(db, `users/${state.user}/resources`), {gold: state.resources.gold, lastUpdate: Date.now()});
      updateUI();
    }
  }
}
async function checkAchievements() {
  if (!state.user) return;
  if (state.level.level >= 5 && !state.achievements.level5) await unlockAchievement('level5');
  if (state.level.level >= 10 && !state.achievements.level10) await unlockAchievement('level10');
  if (state.resources.gold >= 500 && !state.achievements.rich) await unlockAchievement('rich');
  if (state.resources.gold >= 1000 && !state.achievements.millionaire) await unlockAchievement('millionaire');
  if (state.buildings.mines.length >= 2 && !state.achievements.maxMines) await unlockAchievement('maxMines');
  if (state.buildings.rocketLaunchers.length >= 1 && !state.achievements.rocketLauncher) await unlockAchievement('rocketLauncher');
}
$('achievementsButton').onclick = $('islandAchievementsButton').onclick = async () => {
  show(modal('achievements'));
  const snap = await get(ref(db, `users/${state.user}/achievements`));
  state.achievements = snap.exists() ? snap.val() : {};
 
  $('achievementsList').innerHTML = Object.values(ACHIEVEMENTS).map(a => {
    const unlocked = state.achievements[a.id];
    return `
      <div class="achievement-item ${unlocked ? 'unlocked' : ''}">
        <div class="achievement-icon">${a.icon}</div>
        <div class="achievement-info">
          <div class="achievement-name">${a.name}</div>
          <div class="achievement-desc">${a.desc}</div>
          <div class="achievement-reward">Recompensa: ${a.reward}</div>
        </div>
        <div class="achievement-status ${unlocked ? '' : 'locked'}">${unlocked ? '✅' : '🔒'}</div>
      </div>
    `;
  }).join('');
};
// Top Players
$('topPlayersButton').onclick = async () => {
  loading(true);
  show(modal('topPlayers'));
 
  const snap = await get(ref(db, 'users'));
  if (!snap.exists()) {
    $('topPlayersList').innerHTML = '<div style="color:white;text-align:center;padding:20px">No hay jugadores todavía</div>';
    loading(false);
    return;
  }
 
  const players = Object.entries(snap.val())
    .filter(([_, u]) => u.level)
    .map(([name, u]) => {
      const lvl = u.level.level || 1;
      const xp = u.level.xp || 0;
      return {name, level: lvl, xp, totalXP: ((lvl - 1) * lvl * 100 / 2) + xp};
    })
    .sort((a, b) => b.totalXP - a.totalXP)
    .slice(0, 10);
 
  $('topPlayersList').innerHTML = players.length ? players.map((p, i) => {
    const rank = i + 1;
    const cls = rank === 1 ? 'first' : rank === 2 ? 'second' : rank === 3 ? 'third' : '';
    return `
      <div class="top-player-item" onclick="visitPlayer('${p.name}')">
        <div class="top-player-rank ${cls}">${rank}</div>
        <div class="top-player-info">
          <div class="top-player-name">${p.name}</div>
          <div class="top-player-stats">Nivel ${p.level}</div>
        </div>
        <div class="top-player-xp">${Math.floor(p.totalXP)} XP</div>
      </div>
    `;
  }).join('') : '<div style="color:white;text-align:center;padding:20px">No hay jugadores todavía</div>';
 
  loading(false);
};
window.visitPlayer = async name => {
  hide(modal('topPlayers'));
  loading(true);
  const snap = await get(ref(db, 'villages'));
  if (snap.exists()) {
    const village = Object.values(snap.val()).find(v => v.owner === name);
    if (village) openIsland(name);
    else alert(`${name} aún no ha construido su aldea`);
  } else {
    alert(`${name} aún no ha construido su aldea`);
  }
  loading(false);
};
// Inventory
$('inventoryButton').onclick = async () => {
  show(modal('inventory'));
  loading(true);
  const snap = await get(ref(db, `users/${state.user}/inventory/items`));
  state.inventory = snap.exists() ? snap.val() : [];
  
  const rocketAmmoSnap = await get(ref(db, `users/${state.user}/inventory/rocketAmmo`));
  const rocketAmmo = rocketAmmoSnap.exists() ? rocketAmmoSnap.val() : 0;
  loading(false);
 
  $('inventoryItems').innerHTML = state.inventory.length || rocketAmmo > 0 ? 
    (rocketAmmo > 0 ? `
      <div class="shop-item">
        <div class="shop-item-info">
          <div class="shop-item-name">🚀 Cohetes</div>
          <div class="shop-item-desc">Municiones para el lanza cohetes</div>
          <div class="shop-item-desc">Cantidad: ${rocketAmmo}</div>
        </div>
      </div>
    ` : '') + 
    state.inventory.map((item, i) => {
      const info = item === 'statue' ?
        {name: '🗿 Estatua Moai', desc: 'Estatua decorativa única'} :
        {name: '🛠️ Pala', desc: 'Repara áreas dañadas'};
      return `
        <div class="shop-item">
          <div class="shop-item-info">
            <div class="shop-item-name">${info.name}</div>
            <div class="shop-item-desc">${info.desc}</div>
          </div>
          <button onclick="useItem(${i})">Usar</button>
        </div>
      `;
    }).join('') : '<div style="color:white;text-align:center;padding:20px">Inventario vacío</div>';
};
window.useItem = i => {
  state.placing = state.inventory[i];
  hide(modal('inventory'));
  alert(`Haz click en una celda ${state.placing === 'statue' ? 'verde' : 'dañada'} para ${state.placing === 'statue' ? 'colocar la estatua' : 'reparar'}`);
};
// Login/Register
$('loginTab').onclick = () => {
  $('loginTab').classList.add('active');
  $('registerTab').classList.remove('active');
  $('loginForm').classList.add('active');
  $('registerForm').classList.remove('active');
};
$('registerTab').onclick = () => {
  $('registerTab').classList.add('active');
  $('loginTab').classList.remove('active');
  $('registerForm').classList.add('active');
  $('loginForm').classList.remove('active');
};
$('loginBtn').onclick = async () => {
  const user = $('loginUsername').value.trim();
  const pass = $('loginPassword').value;
 
  if (!user || !pass) {
    $('loginError').textContent = 'Por favor completa todos los campos';
    show($('loginError'));
    return;
  }
 
  loading(true);
  const snap = await get(ref(db, `accounts/${user}`));
 
  if (!snap.exists()) {
    $('loginError').textContent = 'Usuario no encontrado';
    show($('loginError'));
    loading(false);
    return;
  }
 
  if (snap.val().password !== pass) {
    $('loginError').textContent = 'Contraseña incorrecta';
    show($('loginError'));
    loading(false);
    return;
  }
 
  state.user = user;
  localStorage.setItem('currentUser', user);
  hide(modal('login'));
 
  const villSnap = await get(ref(db, 'villages'));
  if (villSnap.exists()) {
    state.hasBuilt = Object.values(villSnap.val()).some(v => v.owner === user);
  }
 
  const achSnap = await get(ref(db, `users/${user}/achievements`));
  state.achievements = achSnap.exists() ? snap.val() : {};
 
  if (!localStorage.getItem('tutorialCompleted')) {
    setTimeout(() => show(modal('tutorial')), 500);
  }
 
  loading(false);
};
$('registerBtn').onclick = async () => {
  const user = $('registerUsername').value.trim();
  const pass = $('registerPassword').value;
  const conf = $('registerPasswordConfirm').value;
 
  if (!user || !pass || !conf) {
    $('registerError').textContent = 'Por favor completa todos los campos';
    show($('registerError'));
    return;
  }
 
  if (user.length < 3) {
    $('registerError').textContent = 'El nombre debe tener al menos 3 caracteres';
    show($('registerError'));
    return;
  }
 
  if (pass.length < 6) {
    $('registerError').textContent = 'La contraseña debe tener al menos 6 caracteres';
    show($('registerError'));
    return;
  }
 
  if (pass !== conf) {
    $('registerError').textContent = 'Las contraseñas no coinciden';
    show($('registerError'));
    return;
  }
 
  loading(true);
  const snap = await get(ref(db, `accounts/${user}`));
 
  if (snap.exists()) {
    $('registerError').textContent = 'Este nombre de usuario ya existe';
    show($('registerError'));
    loading(false);
    return;
  }
 
  await set(ref(db, `accounts/${user}`), {password: pass, createdAt: Date.now()});
 
  state.user = user;
  localStorage.setItem('currentUser', user);
  hide(modal('login'));
  loading(false);
 
  alert('¡Cuenta creada exitosamente!');
  setTimeout(() => show(modal('tutorial')), 500);
};
$('logoutButton').onclick = () => {
  if (confirm('¿Seguro que quieres cerrar sesión?')) {
    localStorage.removeItem('currentUser');
    location.reload();
  }
};
// Tutorial
$('tutorialNext').onclick = () => {
  if (state.tutorial.step < 6) {
    document.querySelector(`.tutorial-step[data-step="${state.tutorial.step}"]`).classList.remove('active');
    state.tutorial.step++;
    document.querySelector(`.tutorial-step[data-step="${state.tutorial.step}"]`).classList.add('active');
    $('tutorialCurrentStep').textContent = state.tutorial.step;
    $('tutorialPrev').style.display = 'block';
    if (state.tutorial.step === 6) $('tutorialNext').textContent = '¡Empezar!';
  } else {
    hide(modal('tutorial'));
    localStorage.setItem('tutorialCompleted', 'true');
    state.tutorial.step = 1;
  }
};
$('tutorialPrev').onclick = () => {
  if (state.tutorial.step > 1) {
    document.querySelector(`.tutorial-step[data-step="${state.tutorial.step}"]`).classList.remove('active');
    state.tutorial.step--;
    document.querySelector(`.tutorial-step[data-step="${state.tutorial.step}"]`).classList.add('active');
    $('tutorialCurrentStep').textContent = state.tutorial.step;
    if (state.tutorial.step === 1) $('tutorialPrev').style.display = 'none';
    $('tutorialNext').textContent = 'Siguiente →';
  }
};
// Navigation
$('backButton').onclick = () => {
  $('fade').style.opacity = 1;
  if (state.intervals.gold) {
    clearInterval(state.intervals.gold);
    state.intervals.gold = null;
  }
  state.placing = null;
  state.attacking = false;
  if (state.currentVillage.id) set(ref(db, `villages/${state.currentVillage.id}/underAttack`), false);
 
  setTimeout(() => {
    document.querySelector('.island-view').style.opacity = 0;
    document.querySelector('.island-view').style.pointerEvents = 'none';
    $('islandGridToggle').style.opacity = 0;
    $('islandGridToggle').style.pointerEvents = 'none';
    $('islandAchievementsButton').style.opacity = 0;
    $('islandAchievementsButton').style.pointerEvents = 'none';
    $('resourcesPanel').style.display = 'none';
    $('userInfoPanel').style.display = 'none';
    $('shopButton').style.display = 'none';
    $('inventoryButton').style.display = 'none';
    $('attackButton').style.display = 'none';
    document.querySelector('.map-view').style.opacity = 1;
  }, 400);
 
  setTimeout(() => $('fade').style.opacity = 0, 900);
};
function transition(toIsland) {
  $('fade').style.opacity = 1;
 
  setTimeout(() => {
    if (toIsland) {
      document.querySelector('.map-view').style.opacity = 0;
      document.querySelector('.island-view').style.opacity = 1;
      document.querySelector('.island-view').style.pointerEvents = 'auto';
      $('islandGridToggle').style.opacity = 1;
      $('islandGridToggle').style.pointerEvents = 'auto';
      $('islandAchievementsButton').style.opacity = 1;
      $('islandAchievementsButton').style.pointerEvents = 'auto';
      $('resourcesPanel').style.display = 'block';
      $('userInfoPanel').style.display = 'block';
    }
  }, 400);
 
  setTimeout(() => $('fade').style.opacity = 0, 900);
}
// Grid Toggle
$('gridToggle').onclick = () => {
  state.grids.main = !state.grids.main;
  $('mainGrid').classList.toggle('no-grid');
  $('gridToggle').textContent = state.grids.main ? 'Quitar Cuadrícula' : 'Mostrar Cuadrícula';
};
$('islandGridToggle').onclick = () => {
  state.grids.island = !state.grids.island;
  $('islandGrid').classList.toggle('no-grid');
  $('islandGridToggle').textContent = state.grids.island ? 'Quitar Cuadrícula' : 'Mostrar Cuadrícula';
};
// Day/Night Toggle
$('dayNightToggle').onclick = () => {
  state.nightMode = !state.nightMode;
  document.body.classList.toggle('night-mode');
  $('dayNightToggle').textContent = state.nightMode ? '☀️' : '🌙';
};
// Modal Close Buttons
$('closeShop').onclick = () => hide(modal('shop'));
$('closeInventory').onclick = () => hide(modal('inventory'));
$('closeGlobalShop').onclick = () => hide(modal('globalShop'));
$('closeTopPlayers').onclick = () => hide(modal('topPlayers'));
$('closeAchievements').onclick = () => hide(modal('achievements'));
$('shopButton').onclick = () => {
  show(modal('shop'));
  updateShop();
};
$('attackButton').onclick = async () => {
  show(modal('attack'));
  const snap = await get(ref(db, 'villages'));
  if (snap.exists()) {
    const village = Object.entries(snap.val()).find(([_, v]) => v.owner === state.currentVillage.owner);
    if (village) {
      state.currentVillage.id = village[0];
      await set(ref(db, `villages/${village[0]}/underAttack`), true);
    }
  }
};
$('globalShopButton').onclick = async () => {
  if (!state.user) return alert('Debes iniciar sesión para acceder a la tienda global');
  
  loading(true);
  
  // Cargar recursos del usuario si no están cargados
  if (state.resources.gold === 0 || state.resources.gold === undefined) {
    const resourceSnap = await get(ref(db, `users/${state.user}/resources`));
    if (resourceSnap.exists()) {
      state.resources.gold = resourceSnap.val().gold || 0;
    }
  }
 
  // Inicializar stock si no existe
  let statueSnap = await get(ref(db, 'globalShop/statue'));
  if (!statueSnap.exists()) {
    await set(ref(db, 'globalShop/statue'), {stock: 10});
    statueSnap = await get(ref(db, 'globalShop/statue'));
  }
  
  let rocketAmmoSnap = await get(ref(db, 'globalShop/rocketAmmo'));
  if (!rocketAmmoSnap.exists()) {
    await set(ref(db, 'globalShop/rocketAmmo'), {stock: 10});
    rocketAmmoSnap = await get(ref(db, 'globalShop/rocketAmmo'));
  }
 
  const statueStock = statueSnap.val()?.stock || 0;
  const rocketAmmoStock = rocketAmmoSnap.val()?.stock || 0;
  
  loading(false);
  show(modal('globalShop'));
 
  $('statueStock').textContent = statueStock;
  $('rocketAmmoStock').textContent = rocketAmmoStock;
  $('buyStatueBtn').disabled = statueStock <= 0;
  $('buyStatueBtn').textContent = statueStock <= 0 ? 'Agotado' : 'Comprar';
  $('buyRocketAmmoBtn').disabled = rocketAmmoStock <= 0;
  $('buyRocketAmmoBtn').textContent = rocketAmmoStock <= 0 ? 'Agotado' : 'Comprar';
};
// Drag & Zoom
function setupDrag(viewport, world, view) {
  viewport.addEventListener('mousedown', e => {
    if (e.target === viewport || e.target === world || e.target.classList.contains('cell')) {
      state.drag.active = true;
      state.drag.moved = false;
      state.drag.startX = e.clientX - view.x;
      state.drag.startY = e.clientY - view.y;
      viewport.style.cursor = 'grabbing';
    }
  });
 
  viewport.addEventListener('mouseup', () => {
    state.drag.active = false;
    viewport.style.cursor = 'grab';
  });
 
  viewport.addEventListener('mouseleave', () => {
    state.drag.active = false;
    viewport.style.cursor = 'grab';
  });
 
  viewport.addEventListener('mousemove', e => {
    if (!state.drag.active) return;
    e.preventDefault();
   
    const dx = Math.abs(e.clientX - state.drag.startX - view.x);
    const dy = Math.abs(e.clientY - state.drag.startY - view.y);
    if (dx > 3 || dy > 3) state.drag.moved = true;
   
    view.x = e.clientX - state.drag.startX;
    view.y = e.clientY - state.drag.startY;
    updateTransform(view === state.view.main ? 'main' : 'island');
  });
 
  viewport.addEventListener('wheel', e => {
    e.preventDefault();
    const rect = viewport.getBoundingClientRect();
    const mx = e.clientX - rect.left;
    const my = e.clientY - rect.top;
   
    const beforeX = (mx - view.x) / view.scale;
    const beforeY = (my - view.y) / view.scale;
   
    const delta = e.deltaY < 0 ? 0.1 : -0.1;
    const newScale = Math.min(Math.max(view.scale + delta, 0.3), 3);
   
    const afterX = (mx - view.x) / newScale;
    const afterY = (my - view.y) / newScale;
   
    view.x += (afterX - beforeX) * newScale;
    view.y += (afterY - beforeY) * newScale;
    view.scale = newScale;
   
    updateTransform(view === state.view.main ? 'main' : 'island');
  });
}
function updateTransform(type) {
  const view = type === 'main' ? state.view.main : state.view.island;
  const world = type === 'main' ? $('mainWorld') : $('islandWorld');
  world.style.transform = `translate(${view.x}px, ${view.y}px) scale(${view.scale})`;
}
// Initialize
function init() {
  initMap();
  setupListeners();
  setupDrag($('mainViewport'), $('mainWorld'), state.view.main);
  setupDrag($('islandViewport'), $('islandWorld'), state.view.island);
 
  const saved = localStorage.getItem('currentUser');
  if (saved) {
    state.user = saved;
    hide(modal('login'));
   
    get(ref(db, 'villages')).then(snap => {
      if (snap.exists()) {
        state.hasBuilt = Object.values(snap.val()).some(v => v.owner === saved);
      }
    });
   
    get(ref(db, `users/${saved}/achievements`)).then(snap => {
      state.achievements = snap.exists() ? snap.val() : {};
    });
   
    if (!localStorage.getItem('tutorialCompleted')) {
      setTimeout(() => show(modal('tutorial')), 500);
    }
  }
 
  state.view.main.x = ($('mainViewport').clientWidth - $('mainGrid').offsetWidth) / 2;
  state.view.main.y = ($('mainViewport').clientHeight - $('mainGrid').offsetHeight) / 2;
  updateTransform('main');
}
window.addEventListener('load', init);
</script>
</body>
</html>
