<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panel de AdministraciÃ³n - Aldeas</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
  padding: 20px;
}
.container {
  max-width: 1400px;
  margin: 0 auto;
  background: white;
  border-radius: 20px;
  box-shadow: 0 10px 50px rgba(0,0,0,0.3);
  overflow: hidden;
}
.header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 30px;
  text-align: center;
}
.header h1 {
  font-size: 2.5em;
  margin-bottom: 10px;
}
.header p {
  opacity: 0.9;
  font-size: 1.1em;
}
.tabs {
  display: flex;
  background: #f5f5f5;
  border-bottom: 2px solid #ddd;
}
.tab {
  flex: 1;
  padding: 20px;
  background: #f5f5f5;
  border: none;
  cursor: pointer;
  font-size: 16px;
  font-weight: bold;
  transition: all 0.3s;
  border-bottom: 3px solid transparent;
}
.tab:hover {
  background: #e0e0e0;
}
.tab.active {
  background: white;
  border-bottom: 3px solid #667eea;
  color: #667eea;
}
.content {
  display: none;
  padding: 30px;
  min-height: 500px;
}
.content.active {
  display: block;
}
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 20px;
  margin-bottom: 30px;
}
.stat-card {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 25px;
  border-radius: 15px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}
.stat-card h3 {
  font-size: 0.9em;
  opacity: 0.9;
  margin-bottom: 10px;
  text-transform: uppercase;
}
.stat-card .value {
  font-size: 2.5em;
  font-weight: bold;
}
.section {
  margin-bottom: 30px;
  background: #f9f9f9;
  padding: 25px;
  border-radius: 15px;
}
.section h2 {
  color: #667eea;
  margin-bottom: 20px;
  font-size: 1.8em;
}
.form-group {
  margin-bottom: 20px;
}
.form-group label {
  display: block;
  font-weight: bold;
  margin-bottom: 8px;
  color: #333;
}
.form-group input, .form-group select {
  width: 100%;
  padding: 12px;
  border: 2px solid #ddd;
  border-radius: 8px;
  font-size: 16px;
  transition: border 0.3s;
}
.form-group input:focus, .form-group select:focus {
  outline: none;
  border-color: #667eea;
}
.btn {
  padding: 12px 30px;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s;
  margin-right: 10px;
  margin-bottom: 10px;
}
.btn-primary {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
}
.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
}
.btn-danger {
  background: linear-gradient(135deg, #ff4444 0%, #cc0000 100%);
  color: white;
}
.btn-danger:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(255, 68, 68, 0.4);
}
.btn-success {
  background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
  color: white;
}
.btn-success:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
}
.btn-warning {
  background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
  color: white;
}
.btn-warning:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(255, 152, 0, 0.4);
}
.table-container {
  overflow-x: auto;
  background: white;
  border-radius: 10px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  margin-bottom: 20px;
}
table {
  width: 100%;
  border-collapse: collapse;
}
thead {
  background: #667eea;
  color: white;
}
thead th {
  padding: 15px;
  text-align: left;
  font-weight: bold;
}
tbody tr {
  border-bottom: 1px solid #eee;
  transition: background 0.2s;
}
tbody tr:hover {
  background: #f5f5f5;
}
tbody td {
  padding: 15px;
}
.action-btns button {
  padding: 8px 15px;
  margin-right: 5px;
  margin-bottom: 5px;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  font-size: 14px;
  font-weight: bold;
  transition: all 0.2s;
}
.btn-edit {
  background: #2196F3;
  color: white;
}
.btn-edit:hover {
  background: #0b7dda;
}
.btn-delete {
  background: #f44336;
  color: white;
}
.btn-delete:hover {
  background: #da190b;
}
.loading {
  text-align: center;
  padding: 40px;
  font-size: 18px;
  color: #666;
}
.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: #999;
}
.empty-state .icon {
  font-size: 80px;
  margin-bottom: 20px;
}
.search-box {
  margin-bottom: 20px;
}
.search-box input {
  width: 100%;
  max-width: 400px;
  padding: 12px 20px;
  border: 2px solid #ddd;
  border-radius: 25px;
  font-size: 16px;
}
.search-box input:focus {
  outline: none;
  border-color: #667eea;
}
.inline-form {
  display: flex;
  gap: 15px;
  align-items: flex-end;
  flex-wrap: wrap;
}
.inline-form .form-group {
  flex: 1;
  min-width: 200px;
  margin-bottom: 0;
}
.notification {
  position: fixed;
  top: 20px;
  right: 20px;
  padding: 15px 25px;
  border-radius: 10px;
  color: white;
  font-weight: bold;
  z-index: 1000;
  box-shadow: 0 5px 15px rgba(0,0,0,0.2);
  transform: translateX(400px);
  transition: transform 0.3s ease;
}
.notification.show {
  transform: translateX(0);
}
.notification.success {
  background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
}
.notification.error {
  background: linear-gradient(135deg, #ff4444 0%, #cc0000 100%);
}
.notification.info {
  background: linear-gradient(135deg, #2196F3 0%, #0b7dda 100%);
}
.refresh-btn {
  float: right;
  background: #4CAF50;
  color: white;
  border: none;
  padding: 8px 15px;
  border-radius: 5px;
  cursor: pointer;
  font-size: 14px;
  margin-bottom: 10px;
}
.refresh-btn:hover {
  background: #45a049;
}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>ğŸ› ï¸ Panel de AdministraciÃ³n</h1>
    <p>Sistema de GestiÃ³n de Base de Datos - Aldeas</p>
  </div>

  <div class="tabs">
    <button class="tab active" data-tab="dashboard">ğŸ“Š Dashboard</button>
    <button class="tab" data-tab="users">ğŸ‘¥ Usuarios</button>
    <button class="tab" data-tab="villages">ğŸ° Aldeas</button>
    <button class="tab" data-tab="shop">ğŸ›’ Tienda Global</button>
    <button class="tab" data-tab="visibility">ğŸ‘ï¸ Visibilidad</button>
    <button class="tab" data-tab="backup">ğŸ’¾ Respaldo</button>
  </div>

  <div id="dashboard" class="content active">
    <button class="refresh-btn" onclick="loadDashboard()">ğŸ”„ Actualizar</button>
    <div class="stats-grid">
      <div class="stat-card">
        <h3>Total Usuarios</h3>
        <div class="value" id="totalUsers">0</div>
      </div>
      <div class="stat-card">
        <h3>Total Aldeas</h3>
        <div class="value" id="totalVillages">0</div>
      </div>
      <div class="stat-card">
        <h3>Oro Total en Juego</h3>
        <div class="value" id="totalGold">0</div>
      </div>
      <div class="stat-card">
        <h3>Total Cuentas</h3>
        <div class="value" id="activeUsers">0</div>
      </div>
    </div>

    <div class="section">
      <h2>Top 10 Jugadores por Nivel</h2>
      <div class="table-container">
        <table id="topPlayersTable">
          <thead>
            <tr>
              <th>PosiciÃ³n</th>
              <th>Usuario</th>
              <th>Nivel</th>
              <th>XP Total</th>
              <th>Oro</th>
            </tr>
          </thead>
          <tbody id="topPlayersBody">
            <tr><td colspan="5" class="loading">Cargando...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="users" class="content">
    <button class="refresh-btn" onclick="loadUsers()">ğŸ”„ Actualizar</button>
    <div class="section">
      <h2>GestiÃ³n de Usuarios</h2>
      <div class="search-box">
        <input type="text" id="userSearch" placeholder="ğŸ” Buscar usuario...">
      </div>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Usuario</th>
              <th>Nivel</th>
              <th>XP</th>
              <th>Oro</th>
              <th>Estructuras</th>
              <th>Inventario</th>
              <th>Fecha Registro</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="usersTableBody">
            <tr><td colspan="8" class="loading">Cargando usuarios...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="section">
      <h2>Agregar/Modificar Recursos de Usuario</h2>
      <div class="inline-form">
        <div class="form-group">
          <label>Usuario</label>
          <input type="text" id="modifyUsername" placeholder="Nombre de usuario">
        </div>
        <div class="form-group">
          <label>Oro a Agregar/Quitar</label>
          <input type="number" id="modifyGold" placeholder="Ej: 1000 o -500">
        </div>
        <div class="form-group">
          <label>XP a Agregar</label>
          <input type="number" id="modifyXP" placeholder="Ej: 100">
        </div>
        <div class="form-group">
          <label>Municiones Cohetes</label>
          <input type="number" id="modifyRockets" placeholder="Cantidad">
        </div>
        <div class="form-group">
          <label>Aviones Bombarderos</label>
          <input type="number" id="modifyBombers" placeholder="Cantidad">
        </div>
        <button class="btn btn-primary" id="btnModifyUser">ğŸ’° Aplicar Cambios</button>
      </div>
    </div>

    <div class="section">
      <h2>Crear Usuario Nuevo</h2>
      <div class="inline-form">
        <div class="form-group">
          <label>Nombre de Usuario</label>
          <input type="text" id="newUsername" placeholder="Nombre de usuario">
        </div>
        <div class="form-group">
          <label>ContraseÃ±a</label>
          <input type="password" id="newPassword" placeholder="ContraseÃ±a">
        </div>
        <div class="form-group">
          <label>Oro Inicial</label>
          <input type="number" id="newGold" placeholder="Ej: 1000" value="1000">
        </div>
        <button class="btn btn-success" id="btnCreateUser">ğŸ‘¤ Crear Usuario</button>
      </div>
    </div>
  </div>

  <div id="villages" class="content">
    <button class="refresh-btn" onclick="loadVillages()">ğŸ”„ Actualizar</button>
    <div class="section">
      <h2>Todas las Aldeas</h2>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Propietario</th>
              <th>PosiciÃ³n (Fila, Col)</th>
              <th>Bajo Ataque</th>
              <th>Fecha CreaciÃ³n</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="villagesTableBody">
            <tr><td colspan="6" class="loading">Cargando aldeas...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="section">
      <h2>Eliminar Aldea</h2>
      <div class="inline-form">
        <div class="form-group">
          <label>ID de Aldea</label>
          <input type="text" id="deleteVillageId" placeholder="Ej: 25-30">
        </div>
        <button class="btn btn-danger" id="btnDeleteVillage">ğŸ—‘ï¸ Eliminar Aldea</button>
      </div>
    </div>
  </div>

  <div id="shop" class="content">
    <button class="refresh-btn" onclick="loadShop()">ğŸ”„ Actualizar</button>
    <div class="section">
      <h2>Stock de Tienda Global</h2>
      <div class="stats-grid">
        <div class="stat-card">
          <h3>ğŸ—¿ Estatuas Moai</h3>
          <div class="value" id="statueStock">0</div>
        </div>
        <div class="stat-card">
          <h3>ğŸš€ MuniciÃ³n Cohetes</h3>
          <div class="value" id="rocketStock">0</div>
        </div>
        <div class="stat-card">
          <h3>ğŸŒ¸ Flores</h3>
          <div class="value" id="flowerStock">0</div>
        </div>
        <div class="stat-card">
          <h3>ğŸ›¡ï¸ Torres Desviadoras</h3>
          <div class="value" id="deflectorStock">0</div>
        </div>
        <div class="stat-card">
          <h3>âœˆï¸ Aviones Bombarderos</h3>
          <div class="value" id="bomberStock">0</div>
        </div>
        <div class="stat-card">
          <h3>ğŸ’¥ Super Cohetes</h3>
          <div class="value" id="superRocketAmmoStock">0</div>
        </div>
        <div class="stat-card">
          <h3>ğŸ’¥ Super Lanzadores</h3>
          <div class="value" id="superRocketLauncherStock">0</div>
        </div>
      </div>
    </div>

    <div class="section">
      <h2>Modificar Stock</h2>
      <div class="inline-form">
        <div class="form-group">
          <label>ArtÃ­culo</label>
          <select id="shopItem">
            <option value="statue">ğŸ—¿ Estatua Moai</option>
            <option value="rocketAmmo">ğŸš€ MuniciÃ³n Cohetes</option>
            <option value="flower">ğŸŒ¸ Flores</option>
            <option value="deflectorTower">ğŸ›¡ï¸ Torres Desviadoras</option>
            <option value="bomberPlane">âœˆï¸ Aviones Bombarderos</option>
            <option value="superRocketAmmo">ğŸ’¥ Super Cohetes</option>
            <option value="superRocketLauncher">ğŸ’¥ Super Lanzadores</option>
          </select>
        </div>
        <div class="form-group">
          <label>Nuevo Stock</label>
          <input type="number" id="newStock" placeholder="Ej: 100" min="0">
        </div>
        <button class="btn btn-success" id="btnUpdateStock">âœ… Actualizar Stock</button>
      </div>
    </div>
  </div>

  <div id="visibility" class="content">
    <button class="refresh-btn" onclick="loadVisibility()">ğŸ”„ Actualizar</button>
    <div class="section">
      <h2>ğŸ‘ï¸ Control de Visibilidad de Items</h2>
      <p style="margin-bottom: 20px; color: #666;">Controla quÃ© items se muestran en la tienda global. Los items ocultos no aparecerÃ¡n para los jugadores.</p>
      
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Item</th>
              <th>Stock Actual</th>
              <th>Visible</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="visibilityTableBody">
            <tr><td colspan="4" class="loading">Cargando...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="backup" class="content">
    <div class="section">
      <h2>Exportar Base de Datos</h2>
      <p style="margin-bottom: 20px; color: #666;">Descarga una copia completa de la base de datos en formato JSON</p>
      <button class="btn btn-primary" id="btnExport">ğŸ“¥ Descargar Respaldo Completo</button>
    </div>

    <div class="section">
      <h2>Importar Base de Datos</h2>
      <p style="margin-bottom: 20px; color: #666;">Restaurar datos desde un archivo JSON</p>
      <div class="inline-form">
        <div class="form-group">
          <label>Archivo JSON</label>
          <input type="file" id="importFile" accept=".json">
        </div>
        <button class="btn btn-warning" id="btnImport">ğŸ“¤ Importar Datos</button>
      </div>
    </div>

    <div class="section">
      <h2>Limpiar Datos</h2>
      <p style="margin-bottom: 20px; color: #f44336; font-weight: bold;">âš ï¸ PELIGRO: Estas acciones son irreversibles</p>
      <button class="btn btn-danger" id="btnClearUsers">ğŸ—‘ï¸ Eliminar Todos los Usuarios</button>
      <button class="btn btn-danger" id="btnClearVillages">ğŸ—‘ï¸ Eliminar Todas las Aldeas</button>
      <button class="btn btn-danger" id="btnResetShop">ğŸ”„ Resetear Tienda Global</button>
    </div>
  </div>
</div>

<div id="notification" class="notification"></div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { getDatabase, ref, set, get, remove, update } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

const app = initializeApp({
  apiKey: "AIzaSyClTAw_XLfH3UcCKTisTREZchz41tTxL7g",
  authDomain: "projectmap-382dd.firebaseapp.com",
  databaseURL: "https://projectmap-382dd-default-rtdb.firebaseio.com",
  projectId: "projectmap-382dd",
  storageBucket: "projectmap-382dd.firebasestorage.app",
  messagingSenderId: "1016267509437",
  appId: "1:1016267509437:web:fa243dd82b151383ccb1d4",
  measurementId: "G-4ECYZ37F17"
});

const db = getDatabase(app);

// Variables globales
let usersData = {};
let villagesData = {};

// FunciÃ³n para mostrar notificaciones
function showNotification(message, type = 'info') {
  const notification = document.getElementById('notification');
  notification.textContent = message;
  notification.className = `notification ${type}`;
  notification.classList.add('show');
  
  setTimeout(() => {
    notification.classList.remove('show');
  }, 3000);
}

// Sistema de tabs
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', function() {
    const targetTab = this.getAttribute('data-tab');
    
    // Remover active de todos
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
    
    // Activar el seleccionado
    this.classList.add('active');
    document.getElementById(targetTab).classList.add('active');
    
    // Cargar datos segÃºn la pestaÃ±a
    if (targetTab === 'users') loadUsers();
    if (targetTab === 'villages') loadVillages();
    if (targetTab === 'shop') loadShop();
    if (targetTab === 'visibility') loadVisibility();
  });
});

// Cargar Dashboard
async function loadDashboard() {
  console.log('Cargando dashboard...');
  try {
    const usersSnap = await get(ref(db, 'users'));
    const villagesSnap = await get(ref(db, 'villages'));
    const accountsSnap = await get(ref(db, 'accounts'));
    
    usersData = usersSnap.exists() ? usersSnap.val() : {};
    villagesData = villagesSnap.exists() ? villagesSnap.val() : {};
    const accounts = accountsSnap.exists() ? accountsSnap.val() : {};
    
    const totalUsers = Object.keys(usersData).length;
    const totalVillages = Object.keys(villagesData).length;
    const totalAccounts = Object.keys(accounts).length;
    let totalGold = 0;
    
    Object.values(usersData).forEach(user => {
      if (user.resources?.gold) totalGold += user.resources.gold;
    });
    
    document.getElementById('totalUsers').textContent = totalUsers;
    document.getElementById('totalVillages').textContent = totalVillages;
    document.getElementById('totalGold').textContent = totalGold.toLocaleString();
    document.getElementById('activeUsers').textContent = totalAccounts;
    
    // Top Players
    const players = Object.entries(usersData)
      .filter(([_, u]) => u.level)
      .map(([name, u]) => {
        const lvl = u.level.level || 1;
        const xp = u.level.xp || 0;
        const gold = u.resources?.gold || 0;
        return {name, level: lvl, xp, totalXP: ((lvl - 1) * lvl * 100 / 2) + xp, gold};
      })
      .sort((a, b) => b.totalXP - a.totalXP)
      .slice(0, 10);
    
    const tbody = document.getElementById('topPlayersBody');
    tbody.innerHTML = players.length ? players.map((p, i) => `
      <tr>
        <td><strong>${i + 1}</strong></td>
        <td>${p.name}</td>
        <td>Nivel ${p.level}</td>
        <td>${Math.floor(p.totalXP)} XP</td>
        <td>${p.gold.toLocaleString()} ğŸ’°</td>
      </tr>
    `).join('') : '<tr><td colspan="5" class="empty-state"><div class="icon">ğŸ“­</div><div>No hay jugadores todavÃ­a</div></td></tr>';
    
    console.log('Dashboard cargado correctamente');
    showNotification('Dashboard actualizado', 'success');
  } catch(e) {
    console.error('Error cargando dashboard:', e);
    showNotification('Error cargando dashboard: ' + e.message, 'error');
  }
}

// Cargar Usuarios
async function loadUsers() {
  console.log('Cargando usuarios...');
  try {
    const usersSnap = await get(ref(db, 'users'));
    const accountsSnap = await get(ref(db, 'accounts'));
    
    usersData = usersSnap.exists() ? usersSnap.val() : {};
    const accounts = accountsSnap.exists() ? accountsSnap.val() : {};
    
    const tbody = document.getElementById('usersTableBody');
    const users = Object.entries(usersData).map(([name, data]) => {
      const account = accounts[name] || {};
      const rocketAmmo = data.inventory?.rocketAmmo || 0;
      const bombers = data.inventory?.bomberPlanes || 0;
      const superRocketAmmo = data.inventory?.superRocketAmmo || 0;
      
      return {
        name,
        level: data.level?.level || 1,
        xp: data.level?.xp || 0,
        gold: data.resources?.gold || 0,
        mines: data.buildings?.goldMines?.length || 0,
        rocketLaunchers: data.buildings?.rocketLaunchers?.length || 0,
        superRocketLaunchers: data.buildings?.superRocketLaunchers?.length || 0,
        aaTurrets: data.buildings?.aaTurrets?.length || 0,
        rocketAmmo: rocketAmmo,
        superRocketAmmo: superRocketAmmo,
        bombers: bombers,
        created: account.createdAt ? new Date(account.createdAt).toLocaleDateString() : 'N/A'
      };
    });
    
    tbody.innerHTML = users.length ? users.map(u => `
      <tr>
        <td><strong>${u.name}</strong></td>
        <td>Nivel ${u.level}</td>
        <td>${u.xp} XP</td>
        <td>${u.gold.toLocaleString()} ğŸ’°</td>
        <td>â›ï¸${u.mines} ğŸš€${u.rocketLaunchers} ğŸ’¥${u.superRocketLaunchers} ğŸ›¡ï¸${u.aaTurrets}</td>
        <td>ğŸš€${u.rocketAmmo} ğŸ’¥${u.superRocketAmmo} âœˆï¸${u.bombers}</td>
        <td>${u.created}</td>
        <td class="action-btns">
          <button class="btn-edit" onclick="window.editUser('${u.name}')">âœï¸ Editar</button>
          <button class="btn-delete" onclick="window.deleteUser('${u.name}')">ğŸ—‘ï¸ Eliminar</button>
        </td>
      </tr>
    `).join('') : '<tr><td colspan="8" class="empty-state"><div class="icon">ğŸ‘¤</div><div>No hay usuarios registrados</div></td></tr>';
    
    console.log('Usuarios cargados:', users.length);
    showNotification(`Usuarios cargados: ${users.length}`, 'success');
  } catch(e) {
    console.error('Error cargando usuarios:', e);
    showNotification('Error cargando usuarios: ' + e.message, 'error');
  }
}

// Filtrar usuarios
document.getElementById('userSearch').addEventListener('keyup', function() {
  const search = this.value.toLowerCase();
  const rows = document.querySelectorAll('#usersTableBody tr');
  let visibleCount = 0;
  
  rows.forEach(row => {
    const text = row.textContent.toLowerCase();
    const isVisible = text.includes(search);
    row.style.display = isVisible ? '' : 'none';
    if (isVisible) visibleCount++;
  });
  
  // Mostrar mensaje si no hay resultados
  if (visibleCount === 0 && search) {
    const tbody = document.getElementById('usersTableBody');
    tbody.innerHTML = '<tr><td colspan="8" class="empty-state"><div class="icon">ğŸ”</div><div>No se encontraron usuarios</div></td></tr>';
  }
});

// Modificar recursos de usuario
document.getElementById('btnModifyUser').addEventListener('click', async () => {
  const username = document.getElementById('modifyUsername').value.trim();
  const goldChange = parseInt(document.getElementById('modifyGold').value) || 0;
  const xpAdd = parseInt(document.getElementById('modifyXP').value) || 0;
  const rockets = parseInt(document.getElementById('modifyRockets').value) || 0;
  const bombers = parseInt(document.getElementById('modifyBombers').value) || 0;
  
  if (!username) {
    showNotification('Ingresa un nombre de usuario', 'error');
    return;
  }
  
  try {
    const userSnap = await get(ref(db, `users/${username}`));
    if (!userSnap.exists()) {
      showNotification('Usuario no encontrado', 'error');
      return;
    }
    
    const userData = userSnap.val();
    const currentGold = userData.resources?.gold || 0;
    const currentXP = userData.level?.xp || 0;
    const currentLevel = userData.level?.level || 1;
    
    const newGold = Math.max(0, currentGold + goldChange);
    let newXP = currentXP + xpAdd;
    let newLevel = currentLevel;
    let needed = currentLevel * 100;
    
    while (newXP >= needed && newLevel < 20) {
      newXP -= needed;
      newLevel++;
      needed = newLevel * 100;
    }
    
    const updates = {
      'resources/gold': newGold,
      'resources/lastUpdate': Date.now(),
      'level/level': newLevel,
      'level/xp': newXP,
      'level/needed': needed
    };
    
    // Actualizar municiones de cohetes si se especificÃ³
    if (rockets !== 0) {
      const currentRockets = userData.inventory?.rocketAmmo || 0;
      updates['inventory/rocketAmmo'] = Math.max(0, currentRockets + rockets);
    }
    
    // Actualizar bombarderos si se especificÃ³
    if (bombers !== 0) {
      const currentBombers = userData.inventory?.bombers || 0;
      updates['inventory/bombers'] = Math.max(0, currentBombers + bombers);
    }
    
    await update(ref(db, `users/${username}`), updates);
    
    showNotification(`âœ… Recursos actualizados para ${username}\nOro: ${currentGold} â†’ ${newGold}\nNivel: ${currentLevel} â†’ ${newLevel}`, 'success');
    loadUsers();
    loadDashboard();
  } catch(e) {
    showNotification('Error: ' + e.message, 'error');
  }
});

// Crear nuevo usuario
document.getElementById('btnCreateUser').addEventListener('click', async () => {
  const username = document.getElementById('newUsername').value.trim();
  const password = document.getElementById('newPassword').value;
  const gold = parseInt(document.getElementById('newGold').value) || 1000;
  
  if (!username || !password) {
    showNotification('Completa todos los campos requeridos', 'error');
    return;
  }
  
  if (username.length < 3) {
    showNotification('El nombre de usuario debe tener al menos 3 caracteres', 'error');
    return;
  }
  
  if (password.length < 6) {
    showNotification('La contraseÃ±a debe tener al menos 6 caracteres', 'error');
    return;
  }
  
  try {
    // Verificar si el usuario ya existe
    const userSnap = await get(ref(db, `accounts/${username}`));
    if (userSnap.exists()) {
      showNotification('El usuario ya existe', 'error');
      return;
    }
    
    // Crear cuenta
    await set(ref(db, `accounts/${username}`), {
      password: password,
      createdAt: Date.now()
    });
    
    // Crear datos de usuario
    await set(ref(db, `users/${username}`), {
      resources: {
        gold: gold,
        lastUpdate: Date.now()
      },
      level: {
        level: 1,
        xp: 0,
        needed: 100
      },
      buildings: {
        goldMines: [],
        rocketLaunchers: [],
        statues: [],
        damaged: []
      },
      inventory: {
        items: [],
        rocketAmmo: 0
      },
      achievements: {}
    });
    
    showNotification(`âœ… Usuario "${username}" creado exitosamente`, 'success');
    document.getElementById('newUsername').value = '';
    document.getElementById('newPassword').value = '';
    document.getElementById('newGold').value = '1000';
    loadUsers();
    loadDashboard();
  } catch(e) {
    showNotification('Error: ' + e.message, 'error');
  }
});

// Eliminar usuario
window.deleteUser = async (username) => {
  if (!confirm(`Â¿Seguro que quieres eliminar al usuario "${username}"? Esta acciÃ³n no se puede deshacer.`)) return;
  
  try {
    await remove(ref(db, `users/${username}`));
    await remove(ref(db, `accounts/${username}`));
    
    showNotification(`Usuario "${username}" eliminado correctamente`, 'success');
    loadUsers();
    loadDashboard();
  } catch(e) {
    showNotification('Error: ' + e.message, 'error');
  }
};

// Editar usuario
window.editUser = (username) => {
  document.getElementById('modifyUsername').value = username;
  document.getElementById('modifyUsername').focus();
};

// Cargar aldeas
async function loadVillages() {
  console.log('Cargando aldeas...');
  try {
    const villagesSnap = await get(ref(db, 'villages'));
    villagesData = villagesSnap.exists() ? villagesSnap.val() : {};
    
    const tbody = document.getElementById('villagesTableBody');
    const villages = Object.entries(villagesData).map(([id, data]) => ({
      id,
      owner: data.owner,
      row: data.row,
      col: data.col,
      underAttack: data.underAttack || false,
      timestamp: data.timestamp ? new Date(data.timestamp).toLocaleString() : 'N/A'
    }));
    
    tbody.innerHTML = villages.length ? villages.map(v => `
      <tr>
        <td><strong>${v.id}</strong></td>
        <td>${v.owner}</td>
        <td>(${v.row}, ${v.col})</td>
        <td>${v.underAttack ? 'ğŸ”¥ SÃ' : 'âœ… NO'}</td>
        <td>${v.timestamp}</td>
        <td class="action-btns">
          <button class="btn-delete" onclick="window.deleteVillageById('${v.id}')">ğŸ—‘ï¸ Eliminar</button>
        </td>
      </tr>
    `).join('') : '<tr><td colspan="6" class="empty-state"><div class="icon">ğŸ°</div><div>No hay aldeas construidas</div></td></tr>';
    
    console.log('Aldeas cargadas:', villages.length);
    showNotification(`Aldeas cargadas: ${villages.length}`, 'success');
  } catch(e) {
    console.error('Error cargando aldeas:', e);
    showNotification('Error cargando aldeas: ' + e.message, 'error');
  }
}

// Eliminar aldea
document.getElementById('btnDeleteVillage').addEventListener('click', async () => {
  const id = document.getElementById('deleteVillageId').value.trim();
  if (!id) {
    showNotification('Ingresa un ID de aldea', 'error');
    return;
  }
  
  try {
    const villageSnap = await get(ref(db, `villages/${id}`));
    if (!villageSnap.exists()) {
      showNotification('Aldea no encontrada', 'error');
      return;
    }
    
    if (!confirm(`Â¿Eliminar la aldea ${id}?`)) return;
    
    await remove(ref(db, `villages/${id}`));
    showNotification('Aldea eliminada correctamente', 'success');
    document.getElementById('deleteVillageId').value = '';
    loadVillages();
    loadDashboard();
  } catch(e) {
    showNotification('Error: ' + e.message, 'error');
  }
});

window.deleteVillageById = async (id) => {
  if (!confirm(`Â¿Eliminar la aldea ${id}?`)) return;
  try {
    await remove(ref(db, `villages/${id}`));
    showNotification('Aldea eliminada correctamente', 'success');
    loadVillages();
    loadDashboard();
  } catch(e) {
    showNotification('Error: ' + e.message, 'error');
  }
};

// Cargar tienda
async function loadShop() {
  console.log('Cargando tienda...');
  try {
    const statueSnap = await get(ref(db, 'globalShop/statue'));
    const rocketSnap = await get(ref(db, 'globalShop/rocketAmmo'));
    const flowerSnap = await get(ref(db, 'globalShop/flower'));
    const deflectorSnap = await get(ref(db, 'globalShop/deflectorTower'));
    const bomberSnap = await get(ref(db, 'globalShop/bomberPlane'));
    const superRocketAmmoSnap = await get(ref(db, 'globalShop/superRocketAmmo'));
    const superRocketLauncherSnap = await get(ref(db, 'globalShop/superRocketLauncher'));
    
    const statueStock = statueSnap.exists() ? statueSnap.val().stock : 0;
    const rocketStock = rocketSnap.exists() ? rocketSnap.val().stock : 0;
    const flowerStock = flowerSnap.exists() ? flowerSnap.val().stock : 0;
    const deflectorStock = deflectorSnap.exists() ? deflectorSnap.val().stock : 0;
    const bomberStock = bomberSnap.exists() ? bomberSnap.val().stock : 0;
    const superRocketAmmoStock = superRocketAmmoSnap.exists() ? superRocketAmmoSnap.val().stock : 0;
    const superRocketLauncherStock = superRocketLauncherSnap.exists() ? superRocketLauncherSnap.val().stock : 0;
    
    document.getElementById('statueStock').textContent = statueStock;
    document.getElementById('rocketStock').textContent = rocketStock;
    document.getElementById('flowerStock').textContent = flowerStock;
    document.getElementById('deflectorStock').textContent = deflectorStock;
    document.getElementById('bomberStock').textContent = bomberStock;
    document.getElementById('superRocketAmmoStock').textContent = superRocketAmmoStock;
    document.getElementById('superRocketLauncherStock').textContent = superRocketLauncherStock;
    
    console.log('Tienda cargada');
    showNotification('Tienda actualizada', 'success');
  } catch(e) {
    console.error('Error cargando tienda:', e);
    showNotification('Error cargando tienda: ' + e.message, 'error');
  }
}

// Actualizar stock
document.getElementById('btnUpdateStock').addEventListener('click', async () => {
  const item = document.getElementById('shopItem').value;
  const stock = parseInt(document.getElementById('newStock').value);
  
  if (isNaN(stock) || stock < 0) {
    showNotification('Ingresa un nÃºmero vÃ¡lido', 'error');
    return;
  }
  
  try {
    await set(ref(db, `globalShop/${item}`), {stock, visible: true});
    const itemNames = {
      statue: 'ğŸ—¿ Estatuas',
      rocketAmmo: 'ğŸš€ MuniciÃ³n Cohetes',
      flower: 'ğŸŒ¸ Flores',
      deflectorTower: 'ğŸ›¡ï¸ Torres Desviadoras',
      bomberPlane: 'âœˆï¸ Aviones Bombarderos',
      superRocketAmmo: 'ğŸ’¥ Super Cohetes',
      superRocketLauncher: 'ğŸ’¥ Super Lanzadores'
    };
    showNotification(`âœ… Stock actualizado: ${itemNames[item]} = ${stock}`, 'success');
    document.getElementById('newStock').value = '';
    loadShop();
  } catch(e) {
    showNotification('Error: ' + e.message, 'error');
  }
});

// Cargar visibilidad de items
async function loadVisibility() {
  console.log('Cargando visibilidad...');
  try {
    const shopSnap = await get(ref(db, 'globalShop'));
    const shopData = shopSnap.exists() ? shopSnap.val() : {};
    
    const items = {
      statue: {name: 'ğŸ—¿ Estatua Moai', data: shopData.statue || {stock: 0, visible: true}},
      rocketAmmo: {name: 'ğŸš€ MuniciÃ³n Cohetes', data: shopData.rocketAmmo || {stock: 0, visible: true}},
      flower: {name: 'ğŸŒ¸ Flores', data: shopData.flower || {stock: 0, visible: true}},
      deflectorTower: {name: 'ğŸ›¡ï¸ Torres Desviadoras', data: shopData.deflectorTower || {stock: 0, visible: true}},
      bomberPlane: {name: 'âœˆï¸ Aviones Bombarderos', data: shopData.bomberPlane || {stock: 0, visible: true}},
      superRocketAmmo: {name: 'ğŸ’¥ Super Cohetes', data: shopData.superRocketAmmo || {stock: 0, visible: true}},
      superRocketLauncher: {name: 'ğŸ’¥ Super Lanzadores', data: shopData.superRocketLauncher || {stock: 0, visible: true}}
    };
    
    const tbody = document.getElementById('visibilityTableBody');
    tbody.innerHTML = Object.entries(items).map(([key, item]) => {
      const visible = item.data.visible !== false;
      const stock = item.data.stock || 0;
      return `
        <tr>
          <td><strong>${item.name}</strong></td>
          <td>${stock}</td>
          <td>
            <span style="font-size: 24px;">${visible ? 'âœ…' : 'âŒ'}</span>
            <span style="margin-left: 10px; color: ${visible ? '#4CAF50' : '#f44336'}; font-weight: bold;">
              ${visible ? 'VISIBLE' : 'OCULTO'}
            </span>
          </td>
          <td class="action-btns">
            <button class="btn-${visible ? 'warning' : 'success'}" onclick="window.toggleVisibility('${key}', ${!visible})">
              ${visible ? 'ğŸ‘ï¸ Ocultar' : 'ğŸ‘ï¸ Mostrar'}
            </button>
          </td>
        </tr>
      `;
    }).join('');
    
    console.log('Visibilidad cargada');
    showNotification('Visibilidad actualizada', 'success');
  } catch(e) {
    console.error('Error cargando visibilidad:', e);
    showNotification('Error cargando visibilidad: ' + e.message, 'error');
  }
}

// Toggle visibilidad de item
window.toggleVisibility = async (item, visible) => {
  try {
    const itemSnap = await get(ref(db, `globalShop/${item}`));
    const itemData = itemSnap.exists() ? itemSnap.val() : {stock: 0};
    
    await set(ref(db, `globalShop/${item}`), {
      stock: itemData.stock || 0,
      visible: visible
    });
    
    const itemNames = {
      statue: 'ğŸ—¿ Estatuas',
      rocketAmmo: 'ğŸš€ MuniciÃ³n Cohetes',
      flower: 'ğŸŒ¸ Flores',
      deflectorTower: 'ğŸ›¡ï¸ Torres Desviadoras',
      bomberPlane: 'âœˆï¸ Aviones Bombarderos',
      superRocketAmmo: 'ğŸ’¥ Super Cohetes',
      superRocketLauncher: 'ğŸ’¥ Super Lanzadores'
    };
    
    showNotification(`âœ… ${itemNames[item]} ahora estÃ¡ ${visible ? 'VISIBLE' : 'OCULTO'}`, 'success');
    loadVisibility();
  } catch(e) {
    showNotification('Error: ' + e.message, 'error');
  }
};

// Exportar base de datos
document.getElementById('btnExport').addEventListener('click', async () => {
  try {
    const usersSnap = await get(ref(db, 'users'));
    const villagesSnap = await get(ref(db, 'villages'));
    const accountsSnap = await get(ref(db, 'accounts'));
    const shopSnap = await get(ref(db, 'globalShop'));
    
    const backup = {
      users: usersSnap.val() || {},
      villages: villagesSnap.val() || {},
      accounts: accountsSnap.val() || {},
      globalShop: shopSnap.val() || {},
      timestamp: Date.now(),
      date: new Date().toISOString()
    };
    
    const blob = new Blob([JSON.stringify(backup, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `aldeas-backup-${Date.now()}.json`;
    a.click();
    URL.revokeObjectURL(url);
    showNotification('âœ… Respaldo descargado correctamente', 'success');
  } catch(e) {
    showNotification('Error: ' + e.message, 'error');
  }
});

// Importar base de datos
document.getElementById('btnImport').addEventListener('click', async () => {
  const fileInput = document.getElementById('importFile');
  const file = fileInput.files[0];
  
  if (!file) {
    showNotification('Selecciona un archivo JSON', 'error');
    return;
  }
  
  if (!confirm('âš ï¸ Â¿IMPORTAR DATOS? Esto SOBREESCRIBIRÃ la base de datos actual.')) return;
  
  try {
    const text = await file.text();
    const data = JSON.parse(text);
    
    // Validar estructura bÃ¡sica
    if (!data.users || !data.accounts) {
      showNotification('Archivo invÃ¡lido: estructura incorrecta', 'error');
      return;
    }
    
    // Importar datos
    await set(ref(db, 'users'), data.users || {});
    await set(ref(db, 'accounts'), data.accounts || {});
    await set(ref(db, 'villages'), data.villages || {});
    await set(ref(db, 'globalShop'), data.globalShop || {});
    
    showNotification('âœ… Base de datos importada correctamente', 'success');
    fileInput.value = '';
    loadDashboard();
  } catch(e) {
    showNotification('Error: ' + e.message, 'error');
  }
});

// Limpiar datos
document.getElementById('btnClearUsers').addEventListener('click', async () => {
  if (!confirm('âš ï¸ Â¿ELIMINAR TODOS LOS USUARIOS? Esta acciÃ³n es IRREVERSIBLE.')) return;
  if (!confirm('Â¿EstÃ¡s completamente seguro? Se perderÃ¡n todos los datos de usuarios.')) return;
  
  try {
    await remove(ref(db, 'users'));
    await remove(ref(db, 'accounts'));
    showNotification('âœ… Todos los usuarios han sido eliminados', 'success');
    setTimeout(() => location.reload(), 2000);
  } catch(e) {
    showNotification('Error: ' + e.message, 'error');
  }
});

document.getElementById('btnClearVillages').addEventListener('click', async () => {
  if (!confirm('âš ï¸ Â¿ELIMINAR TODAS LAS ALDEAS? Esta acciÃ³n es IRREVERSIBLE.')) return;
  
  try {
    await remove(ref(db, 'villages'));
    showNotification('âœ… Todas las aldeas han sido eliminadas', 'success');
    setTimeout(() => location.reload(), 2000);
  } catch(e) {
    showNotification('Error: ' + e.message, 'error');
  }
});

document.getElementById('btnResetShop').addEventListener('click', async () => {
  if (!confirm('âš ï¸ Â¿RESETEAR LA TIENDA GLOBAL? Se restaurarÃ¡n los stocks por defecto.')) return;
  
  try {
    await set(ref(db, 'globalShop'), {
      statue: {stock: 10, visible: true},
      rocketAmmo: {stock: 10, visible: true},
      flower: {stock: 15, visible: true},
      deflectorTower: {stock: 5, visible: true},
      bomberPlane: {stock: 8, visible: true},
      superRocketAmmo: {stock: 5, visible: true},
      superRocketLauncher: {stock: 3, visible: true}
    });
    showNotification('âœ… Tienda global reseteada con todos los items', 'success');
    loadShop();
    loadVisibility();
  } catch(e) {
    showNotification('Error: ' + e.message, 'error');
  }
});

// Inicializar
async function init() {
  console.log('Inicializando panel de administraciÃ³n...');
  await loadDashboard();
  console.log('Panel listo');
}

window.addEventListener('load', init);
</script>
</body>
</html>
